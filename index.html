<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Baustellen-Planer mit Karte</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    .task-marker {
      background: #3b82f6;
      border: 2px solid white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
    }
    .task-marker.completed {
      background: #10b981;
    }
    .task-marker.high {
      background: #ef4444;
    }
    .task-marker.medium {
      background: #f59e0b;
    }
  </style>
</head>
<body class="bg-gray-50 font-sans">
<div class="max-w-md mx-auto bg-white min-h-screen pb-20">
  <!-- Header -->
  <div class="bg-blue-600 text-white p-4 sticky top-0 z-50">
    <h1 class="text-xl font-bold text-center">ğŸ“ Baustellen-Planer</h1>
    <div class="flex justify-center mt-2 space-x-1">
      <button id="listViewBtn" class="px-2 py-1 bg-blue-500 text-white text-xs" style="border-radius: 8px;">ğŸ“‹ Liste</button>
      <button id="mapViewBtn" class="px-2 py-1 bg-blue-100 text-blue-600 text-xs" style="border-radius: 8px;">ğŸ—ºï¸ Karte</button>
      <button id="calendarViewBtn" class="px-2 py-1 bg-blue-100 text-blue-600 text-xs" style="border-radius: 8px;">ğŸ“… Kalender</button>
      <button id="statsViewBtn" class="px-2 py-1 bg-blue-100 text-blue-600 text-xs" style="border-radius: 8px;">ğŸ“Š Statistik</button>
    </div>
  </div>

  <!-- Add Task Form -->
  <div id="addTaskForm" class="hidden p-4 bg-white border-b">
    <div class="space-y-3">
      <input type="text" id="taskName" placeholder="Name des Kunden..."
             class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="border-radius: 8px;">

      <input type="text" id="taskTitle" placeholder="Aufgabe eingeben..."
             class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="border-radius: 8px;">

      <div class="relative">
        <input type="text" id="taskLocation" placeholder="Adresse (z.B. Alexanderplatz 1, Berlin)..."
               class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="border-radius: 8px;"
               autocomplete="off">
        <div id="addressSuggestions" class="absolute z-50 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto hidden" style="border-radius: 8px;">
          <!-- Address suggestions will appear here -->
        </div>
      </div>

      <input type="number" id="taskCustomerPrice" placeholder="Kundenpreis in â‚¬ (optional)" step="0.01" min="0"
             class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="border-radius: 8px;">

      <input type="number" id="taskSpareParts" placeholder="Ersatzteile in â‚¬ (optional)" step="0.01" min="0"
             class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="border-radius: 8px;">

      <input type="tel" id="taskPhone" placeholder="Telefonnummer (optional)"
             class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="border-radius: 8px;">

      <input type="date" id="taskDate"
             class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="border-radius: 8px;"
             title="Geplantes Datum (optional)">

      <div class="w-full p-3 border rounded-lg bg-gray-50" style="border-radius: 8px;">
        <span class="text-gray-600">Einnahmen: </span>
        <span id="calculatedEarnings" class="font-bold text-green-600">0,00 â‚¬</span>
      </div>

      <div class="flex space-x-2">
        <select id="taskPriority" class="flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" style="border-radius: 8px;">
          <option value="low">ğŸ”µ Offen</option>
          <option value="medium">ğŸŸ¢ Geplant</option>
          <option value="high">ğŸ”´ Dringend</option>
        </select>

        <button id="addTaskBtn" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium" style="border-radius: 8px;">
          â• HinzufÃ¼gen
        </button>
      </div>

      <button id="cancelFormBtn" class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-medium" style="border-radius: 8px;">
        âŒ Abbrechen
      </button>
    </div>
  </div>

  <!-- Edit Task Form -->
  <div id="editTaskForm" class="hidden p-4 bg-white border-b">
    <h3 class="text-lg font-bold mb-3 text-blue-600">âœï¸ Aufgabe bearbeiten</h3>
    <div class="space-y-3">
      <input type="text" id="editTaskName" placeholder="Name des Kunden..."
             class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="border-radius: 8px;">

      <input type="text" id="editTaskTitle" placeholder="Aufgabe eingeben..."
             class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="border-radius: 8px;">

      <div class="relative">
        <input type="text" id="editTaskLocation" placeholder="Adresse (z.B. Alexanderplatz 1, Berlin)..."
               class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="border-radius: 8px;"
               autocomplete="off">
        <div id="editAddressSuggestions" class="absolute z-50 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto hidden" style="border-radius: 8px;">
          <!-- Address suggestions will appear here -->
        </div>
      </div>

      <input type="number" id="editTaskCustomerPrice" placeholder="Kundenpreis in â‚¬ (optional)" step="0.01" min="0"
             class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="border-radius: 8px;">

      <input type="number" id="editTaskSpareParts" placeholder="Ersatzteile in â‚¬ (optional)" step="0.01" min="0"
             class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="border-radius: 8px;">

      <input type="tel" id="editTaskPhone" placeholder="Telefonnummer (optional)"
             class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="border-radius: 8px;">

      <input type="date" id="editTaskDate"
             class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="border-radius: 8px;"
             title="Geplantes Datum (optional)">

      <div class="w-full p-3 border rounded-lg bg-gray-50" style="border-radius: 8px;">
        <span class="text-gray-600">Einnahmen: </span>
        <span id="editCalculatedEarnings" class="font-bold text-green-600">0,00 â‚¬</span>
      </div>

      <div class="flex space-x-2">
        <select id="editTaskPriority" class="flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" style="border-radius: 8px;">
          <option value="low">ğŸ”µ Offen</option>
          <option value="medium">ğŸŸ¢ Geplant</option>
          <option value="high">ğŸ”´ Dringend</option>
        </select>

        <button id="saveTaskBtn" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium" style="border-radius: 8px;">
          ğŸ’¾ Speichern
        </button>
      </div>

      <button id="cancelEditBtn" class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-medium" style="border-radius: 8px;">
        âŒ Abbrechen
      </button>
    </div>
  </div>

  <!-- List View -->
  <div id="listView" class="p-4">
    <!-- Task Filter Tabs -->
    <div class="mb-6">
      <div class="flex justify-center mb-4 space-x-1 overflow-x-auto">
        <button id="allTasksBtn" class="px-3 py-2 bg-blue-100 text-blue-600 text-xs whitespace-nowrap" style="border-radius: 8px;">ğŸ“‹ Alle</button>
        <button id="openTasksBtn" class="px-3 py-2 bg-blue-500 text-white text-xs whitespace-nowrap" style="border-radius: 8px;">ğŸ”µ Offen</button>
        <button id="plannedTasksBtn" class="px-3 py-2 bg-blue-100 text-blue-600 text-xs whitespace-nowrap" style="border-radius: 8px;">ğŸŸ¢ Geplant</button>
        <button id="urgentTasksBtn" class="px-3 py-2 bg-blue-100 text-blue-600 text-xs whitespace-nowrap" style="border-radius: 8px;">ğŸ”´ Dringend</button>
        <button id="completedTasksBtn" class="px-3 py-2 bg-blue-100 text-blue-600 text-xs whitespace-nowrap" style="border-radius: 8px;">âœ… Erledigt</button>
      </div>
    </div>

    <div id="taskList" class="space-y-3">
      <!-- Tasks will be added here -->
    </div>
    <div id="emptyState" class="text-center py-16 text-gray-500">
      <div class="bg-gray-50 rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-6">
        <div class="text-4xl">ğŸ“</div>
      </div>
      <h3 class="text-lg font-semibold text-gray-700 mb-2">Keine Aufgaben vorhanden</h3>
      <p class="text-sm text-gray-500 mb-6">FÃ¼gen Sie Ihre erste Aufgabe hinzu und beginnen Sie mit der Planung!</p>
      <button onclick="document.getElementById('toggleFormBtn').click()"
              class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200 font-medium">
        â• Erste Aufgabe erstellen
      </button>
    </div>
  </div>

  <!-- Map View -->
  <div id="mapView" class="hidden">
    <div id="map" style="height: calc(100vh - 220px); width: 100%;"></div>
    <div class="p-4 bg-white border-t">
      <div class="flex justify-between items-center text-sm">
        <div class="flex items-center space-x-3 text-xs">
          <span class="flex items-center"><span class="w-3 h-3 bg-red-500 rounded-full mr-1"></span> Dringend</span>
          <span class="flex items-center"><span class="w-3 h-3 bg-green-500 rounded-full mr-1"></span> Geplant</span>
          <span class="flex items-center"><span class="w-3 h-3 bg-blue-500 rounded-full mr-1"></span> Offen</span>
        </div>
        <span id="taskCount" class="text-gray-600">0 Aufgaben</span>
      </div>
    </div>
  </div>

  <!-- Calendar View -->
  <div id="calendarView" class="hidden p-4">
    <div class="mb-4">
      <!-- Calendar View Toggle -->
      <div class="flex justify-center mb-4 space-x-1">
        <button id="monthViewBtn" class="px-3 py-1 bg-blue-500 text-white text-xs" style="border-radius: 8px;">ğŸ“… Monat</button>
        <button id="weekViewBtn" class="px-3 py-1 bg-blue-100 text-blue-600 text-xs" style="border-radius: 8px;">ğŸ“† Woche</button>
        <button id="dayViewBtn" class="px-3 py-1 bg-blue-100 text-blue-600 text-xs" style="border-radius: 8px;">ğŸ“‹ Tag</button>
      </div>

      <div class="flex justify-between items-center mb-4">
        <button id="prevPeriod" class="p-2 bg-blue-500 text-white hover:bg-blue-600" style="border-radius: 8px;">â€¹</button>
        <h3 id="currentPeriod" class="text-lg font-bold"></h3>
        <button id="nextPeriod" class="p-2 bg-blue-500 text-white hover:bg-blue-600" style="border-radius: 8px;">â€º</button>
      </div>

      <!-- Month View -->
      <div id="monthView">
        <div class="grid grid-cols-7 gap-1 mb-2">
          <div class="text-center text-xs font-bold p-2 text-gray-600">Mo</div>
          <div class="text-center text-xs font-bold p-2 text-gray-600">Di</div>
          <div class="text-center text-xs font-bold p-2 text-gray-600">Mi</div>
          <div class="text-center text-xs font-bold p-2 text-gray-600">Do</div>
          <div class="text-center text-xs font-bold p-2 text-gray-600">Fr</div>
          <div class="text-center text-xs font-bold p-2 text-gray-600">Sa</div>
          <div class="text-center text-xs font-bold p-2 text-gray-600">So</div>
        </div>

        <div id="calendarGrid" class="grid grid-cols-7 gap-1">
          <!-- Calendar days will be generated here -->
        </div>
      </div>

      <!-- Week View -->
      <div id="weekView" class="hidden">
        <div class="grid grid-cols-7 gap-1 mb-2">
          <div class="text-center text-xs font-bold p-2 text-gray-600">Mo</div>
          <div class="text-center text-xs font-bold p-2 text-gray-600">Di</div>
          <div class="text-center text-xs font-bold p-2 text-gray-600">Mi</div>
          <div class="text-center text-xs font-bold p-2 text-gray-600">Do</div>
          <div class="text-center text-xs font-bold p-2 text-gray-600">Fr</div>
          <div class="text-center text-xs font-bold p-2 text-gray-600">Sa</div>
          <div class="text-center text-xs font-bold p-2 text-gray-600">So</div>
        </div>

        <div id="weekGrid" class="grid grid-cols-7 gap-1">
          <!-- Week days will be generated here -->
        </div>
      </div>

      <!-- Day View -->
      <div id="dayView" class="hidden">
        <div id="dayContainer" class="bg-white border rounded-lg p-4 min-h-[400px]">
          <!-- Day tasks will be generated here -->
        </div>
      </div>
    </div>

    <div class="bg-white border p-5 shadow-sm" style="border-radius: 8px;">
      <div class="flex items-center justify-between mb-4">
        <h4 class="text-lg font-bold text-gray-800 flex items-center">
          <span class="bg-blue-100 p-2 mr-3" style="border-radius: 8px;">ğŸ“‹</span>
          Ungeplante Aufgaben
        </h4>
        <span id="unplannedCount" class="px-3 py-1 bg-gray-100 text-gray-600 text-sm font-medium" style="border-radius: 8px;">0</span>
      </div>
      <div id="unplannedTasks" class="space-y-3 min-h-[120px] border-2 border-dashed border-gray-300 p-4 bg-gray-50" style="border-radius: 8px;">
        <!-- Unplanned tasks will be shown here -->
      </div>
    </div>
  </div>

  <!-- Statistics View -->
  <div id="statsView" class="hidden p-4">
    <div class="space-y-4">
      <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4" style="border-radius: 8px;">
        <h3 class="text-lg font-bold mb-2">ğŸ’° EinnahmenÃ¼bersicht</h3>
        <div class="text-2xl font-bold" id="totalCosts">0,00 â‚¬</div>
        <div class="text-sm opacity-90">Gesamteinnahmen erledigter Aufgaben</div>
      </div>

      <div class="bg-white border p-4" style="border-radius: 8px;">
        <h4 class="font-bold mb-3">ğŸ“Š Monatliche Ãœbersicht</h4>
        <div id="monthlyStats" class="space-y-2">
          <!-- Monthly stats will be added here -->
        </div>
      </div>

      <div class="bg-white border p-4" style="border-radius: 8px;">
        <h4 class="font-bold mb-3">ğŸ“ˆ Aktuelle Statistiken</h4>
        <div class="grid grid-cols-2 gap-4 text-center">
          <div class="bg-blue-50 p-3" style="border-radius: 8px;">
            <div class="text-2xl font-bold text-blue-600" id="openTasks">0</div>
            <div class="text-sm text-gray-600">Offene Aufgaben</div>
          </div>
          <div class="bg-green-50 p-3" style="border-radius: 8px;">
            <div class="text-2xl font-bold text-green-600" id="completedTasks">0</div>
            <div class="text-sm text-gray-600">Erledigt</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Task Modal -->
  <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
      <div id="taskModalContent">
        <!-- Task details will be loaded here -->
      </div>
    </div>
  </div>
</div>

<!-- Fixed Add Task Button -->
<div class="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50">
  <button id="toggleFormBtn" class="px-6 py-3 bg-blue-600 text-white hover:bg-blue-700 font-medium flex items-center justify-center space-x-2 shadow-lg" style="border-radius: 8px;">
    <span>â• Neue Aufgabe</span>
  </button>
</div>

<script>
  let tasks = [];
  let map = null;
  let currentView = 'list';
  let currentDate = new Date();
  let draggedTask = null;
  let editingTaskId = null;
  let calendarViewMode = 'month'; // 'month', 'week', 'day'
  let currentFilter = 'open'; // 'all', 'open', 'planned', 'urgent', 'completed'

  // LocalStorage functions
  function saveTasksToStorage() {
    try {
      localStorage.setItem('taskPlannerTasks', JSON.stringify(tasks));
    } catch (error) {
      console.error('Fehler beim Speichern der Aufgaben:', error);
    }
  }

  function loadTasksFromStorage() {
    try {
      const storedTasks = localStorage.getItem('taskPlannerTasks');
      if (storedTasks) {
        tasks = JSON.parse(storedTasks);
      }
    } catch (error) {
      console.error('Fehler beim Laden der Aufgaben:', error);
      tasks = [];
    }
  }

  // Address suggestion variables
  let addressSuggestionTimeout = null;
  let currentSuggestionInput = null;

  // Geocoding function to get coordinates from address
  async function geocodeAddress(address) {
    try {
      const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
      const data = await response.json();

      if (data && data.length > 0) {
        return {
          lat: parseFloat(data[0].lat),
          lng: parseFloat(data[0].lon),
          displayName: data[0].display_name
        };
      }
      return null;
    } catch (error) {
      console.error('Geocoding error:', error);
      return null;
    }
  }

  // Address suggestion function
  async function searchAddressSuggestions(query, suggestionsContainer) {
    if (query.length < 3) {
      suggestionsContainer.classList.add('hidden');
      return;
    }

    try {
      // Prioritize Austria and Germany in search
      const countryBias = '&countrycodes=at,de';
      const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}${countryBias}&limit=8&addressdetails=1`);
      const data = await response.json();

      if (data && data.length > 0) {
        displayAddressSuggestions(data, suggestionsContainer);
      } else {
        suggestionsContainer.classList.add('hidden');
      }
    } catch (error) {
      console.error('Address suggestion error:', error);
      suggestionsContainer.classList.add('hidden');
    }
  }

  function displayAddressSuggestions(suggestions, container) {
    // Sort suggestions: Austria first, then Germany, then others
    const sortedSuggestions = suggestions.sort((a, b) => {
      const countryA = a.address?.country || '';
      const countryB = b.address?.country || '';

      const isAustriaA = countryA === 'Ã–sterreich' || countryA === 'Austria';
      const isAustriaB = countryB === 'Ã–sterreich' || countryB === 'Austria';
      const isGermanyA = countryA === 'Deutschland' || countryA === 'Germany';
      const isGermanyB = countryB === 'Deutschland' || countryB === 'Germany';

      if (isAustriaA && !isAustriaB) return -1;
      if (!isAustriaA && isAustriaB) return 1;
      if (isGermanyA && !isGermanyB && !isAustriaB) return -1;
      if (!isGermanyA && isGermanyB && !isAustriaA) return 1;

      return 0;
    });

    container.innerHTML = sortedSuggestions.map(suggestion => {
      const address = suggestion.display_name;
      const country = suggestion.address?.country || '';
      const countryFlag = country === 'Ã–sterreich' || country === 'Austria' ? 'ğŸ‡¦ğŸ‡¹' :
        country === 'Deutschland' || country === 'Germany' ? 'ğŸ‡©ğŸ‡ª' : 'ğŸŒ';

      // Extract city/town from address components
      const city = suggestion.address?.city ||
        suggestion.address?.town ||
        suggestion.address?.village ||
        suggestion.address?.municipality ||
        suggestion.name ||
        suggestion.display_name.split(',')[0];

      // Create shortened preview (city + country)
      const shortPreview = `${city}, ${country}`;

      return `
                <div class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0 suggestion-item"
                     data-address="${address}"
                     data-lat="${suggestion.lat}"
                     data-lon="${suggestion.lon}">
                    <div class="flex items-start space-x-2">
                        <span class="text-lg mt-0.5">${countryFlag}</span>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-gray-900 truncate">${suggestion.name || suggestion.display_name.split(',')[0]}</div>
                            <div class="text-sm text-gray-600 truncate">${shortPreview}</div>
                        </div>
                    </div>
                </div>
            `;
    }).join('');

    container.classList.remove('hidden');

    // Add click handlers to suggestions
    container.querySelectorAll('.suggestion-item').forEach(item => {
      item.addEventListener('click', () => {
        const address = item.getAttribute('data-address');
        currentSuggestionInput.value = address;
        container.classList.add('hidden');
        currentSuggestionInput.focus();
      });
    });
  }

  function setupAddressSuggestions(inputId, suggestionsId) {
    const input = document.getElementById(inputId);
    const suggestions = document.getElementById(suggestionsId);

    input.addEventListener('input', (e) => {
      currentSuggestionInput = input;
      const query = e.target.value.trim();

      // Clear previous timeout
      if (addressSuggestionTimeout) {
        clearTimeout(addressSuggestionTimeout);
      }

      // Debounce the search
      addressSuggestionTimeout = setTimeout(() => {
        searchAddressSuggestions(query, suggestions);
      }, 300);
    });

    input.addEventListener('focus', () => {
      currentSuggestionInput = input;
      if (input.value.length >= 3) {
        searchAddressSuggestions(input.value.trim(), suggestions);
      }
    });

    input.addEventListener('blur', (e) => {
      // Delay hiding to allow clicking on suggestions
      setTimeout(() => {
        if (!suggestions.matches(':hover')) {
          suggestions.classList.add('hidden');
        }
      }, 150);
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', (e) => {
      if (!input.contains(e.target) && !suggestions.contains(e.target)) {
        suggestions.classList.add('hidden');
      }
    });
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
    loadTasksFromStorage();
    initializeMap();
    updateTaskDisplay();

    // Event listeners
    document.getElementById('addTaskBtn').addEventListener('click', addTask);
    document.getElementById('toggleFormBtn').addEventListener('click', toggleTaskForm);
    document.getElementById('cancelFormBtn').addEventListener('click', hideTaskForm);
    document.getElementById('saveTaskBtn').addEventListener('click', saveEditedTask);
    document.getElementById('cancelEditBtn').addEventListener('click', hideEditForm);
    document.getElementById('listViewBtn').addEventListener('click', () => switchView('list'));
    document.getElementById('mapViewBtn').addEventListener('click', () => switchView('map'));
    document.getElementById('calendarViewBtn').addEventListener('click', () => switchView('calendar'));
    document.getElementById('statsViewBtn').addEventListener('click', () => switchView('stats'));

    // Calendar navigation
    document.getElementById('prevPeriod').addEventListener('click', () => changePeriod(-1));
    document.getElementById('nextPeriod').addEventListener('click', () => changePeriod(1));

    // Calendar view mode buttons
    document.getElementById('monthViewBtn').addEventListener('click', () => switchCalendarView('month'));
    document.getElementById('weekViewBtn').addEventListener('click', () => switchCalendarView('week'));
    document.getElementById('dayViewBtn').addEventListener('click', () => switchCalendarView('day'));

    // Task filter buttons
    document.getElementById('allTasksBtn').addEventListener('click', () => setTaskFilter('all'));
    document.getElementById('openTasksBtn').addEventListener('click', () => setTaskFilter('open'));
    document.getElementById('plannedTasksBtn').addEventListener('click', () => setTaskFilter('planned'));
    document.getElementById('urgentTasksBtn').addEventListener('click', () => setTaskFilter('urgent'));
    document.getElementById('completedTasksBtn').addEventListener('click', () => setTaskFilter('completed'));

    // Enter key support
    document.getElementById('taskTitle').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') addTask();
    });
    document.getElementById('taskLocation').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') addTask();
    });

    // Calculate earnings when prices change
    document.getElementById('taskCustomerPrice').addEventListener('input', calculateEarnings);
    document.getElementById('taskSpareParts').addEventListener('input', calculateEarnings);
    document.getElementById('editTaskCustomerPrice').addEventListener('input', calculateEditEarnings);
    document.getElementById('editTaskSpareParts').addEventListener('input', calculateEditEarnings);

    // Setup address suggestions
    setupAddressSuggestions('taskLocation', 'addressSuggestions');
    setupAddressSuggestions('editTaskLocation', 'editAddressSuggestions');
  });

  function initializeMap() {
    map = L.map('map').setView([48.4569, 13.4378], 12); // SchÃ¤rding, OberÃ¶sterreich center

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
  }

  function toggleTaskForm() {
    const form = document.getElementById('addTaskForm');
    const toggleBtn = document.getElementById('toggleFormBtn');

    if (form.classList.contains('hidden')) {
      form.classList.remove('hidden');
      toggleBtn.innerHTML = '<span>â– SchlieÃŸen</span>';
      // Focus on first input
      document.getElementById('taskTitle').focus();
    } else {
      form.classList.add('hidden');
      toggleBtn.innerHTML = '<span>â• Neue Aufgabe</span>';
    }
  }

  function hideTaskForm() {
    const form = document.getElementById('addTaskForm');
    const toggleBtn = document.getElementById('toggleFormBtn');

    form.classList.add('hidden');
    toggleBtn.innerHTML = '<span>â• Neue Aufgabe</span>';

    // Clear form
    document.getElementById('taskName').value = '';
    document.getElementById('taskTitle').value = '';
    document.getElementById('taskLocation').value = '';
    document.getElementById('taskCustomerPrice').value = '';
    document.getElementById('taskSpareParts').value = '';
    document.getElementById('taskPhone').value = '';
    document.getElementById('taskDate').value = '';
    document.getElementById('taskPriority').value = 'low';
    calculateEarnings();
  }

  function calculateEarnings() {
    const customerPrice = parseFloat(document.getElementById('taskCustomerPrice').value) || 0;
    const spareParts = parseFloat(document.getElementById('taskSpareParts').value) || 0;
    const earnings = customerPrice - spareParts;

    document.getElementById('calculatedEarnings').textContent = earnings.toFixed(2) + ' â‚¬';
    document.getElementById('calculatedEarnings').className = earnings >= 0 ? 'font-bold text-green-600' : 'font-bold text-red-600';
  }

  function calculateEditEarnings() {
    const customerPrice = parseFloat(document.getElementById('editTaskCustomerPrice').value) || 0;
    const spareParts = parseFloat(document.getElementById('editTaskSpareParts').value) || 0;
    const earnings = customerPrice - spareParts;

    document.getElementById('editCalculatedEarnings').textContent = earnings.toFixed(2) + ' â‚¬';
    document.getElementById('editCalculatedEarnings').className = earnings >= 0 ? 'font-bold text-green-600' : 'font-bold text-red-600';
  }

  async function addTask() {
    const name = document.getElementById('taskName').value.trim();
    const title = document.getElementById('taskTitle').value.trim();
    const location = document.getElementById('taskLocation').value.trim();
    const customerPrice = parseFloat(document.getElementById('taskCustomerPrice').value) || 0;
    const spareParts = parseFloat(document.getElementById('taskSpareParts').value) || 0;
    const phone = document.getElementById('taskPhone').value.trim();
    const plannedDate = document.getElementById('taskDate').value || null;
    const earnings = customerPrice - spareParts;
    const priority = document.getElementById('taskPriority').value;

    if (!name || !title || !location) {
      alert('Bitte fÃ¼llen Sie Name, Titel und Adresse aus!');
      return;
    }

    // Show loading state
    const addBtn = document.getElementById('addTaskBtn');
    const originalText = addBtn.innerHTML;
    addBtn.innerHTML = 'ğŸ”„ Suche Adresse...';
    addBtn.disabled = true;

    try {
      // Get coordinates for the actual address
      const geocodeResult = await geocodeAddress(location);

      if (!geocodeResult) {
        alert('Adresse konnte nicht gefunden werden. Bitte Ã¼berprÃ¼fen Sie die Eingabe.');
        return;
      }

      // Automatically set status to "planned" if a date is provided
      const finalPriority = plannedDate && priority !== 'high' ? 'medium' : priority;

      const task = {
        id: Date.now(),
        name: name,
        title: title,
        location: location,
        fullAddress: geocodeResult.displayName,
        customerPrice: customerPrice,
        spareParts: spareParts,
        phone: phone,
        earnings: earnings,
        priority: finalPriority,
        completed: false,
        coordinates: [geocodeResult.lat, geocodeResult.lng],
        createdAt: new Date().toLocaleDateString('de-DE'),
        completedAt: null,
        plannedDate: plannedDate
      };

      tasks.push(task);
      saveTasksToStorage();

      // Clear form and hide it
      hideTaskForm();

      updateTaskDisplay();
    } catch (error) {
      alert('Fehler beim HinzufÃ¼gen der Aufgabe. Bitte versuchen Sie es erneut.');
    } finally {
      // Reset button
      addBtn.innerHTML = originalText;
      addBtn.disabled = false;
    }
  }

  function openNavigation(coordinates, address) {
    const lat = coordinates[0];
    const lng = coordinates[1];

    // Try to open in native maps app first, fallback to Google Maps web
    const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;

    // For mobile devices, try to open native app
    if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
      const nativeUrl = `geo:${lat},${lng}?q=${lat},${lng}(${encodeURIComponent(address)})`;

      // Try native first, fallback to web
      const link = document.createElement('a');
      link.href = nativeUrl;
      link.click();

      // Fallback after short delay
      setTimeout(() => {
        window.open(mapsUrl, '_blank');
      }, 500);
    } else {
      window.open(mapsUrl, '_blank');
    }
  }

  function makePhoneCall(phoneNumber) {
    if (!phoneNumber) return;

    // Clean phone number (remove spaces, dashes, etc.)
    const cleanNumber = phoneNumber.replace(/[^\\d+]/g, '');

    // Create tel: link
    const telLink = `tel:${cleanNumber}`;

    // Try to open phone app
    const link = document.createElement('a');
    link.href = telLink;
    link.click();
  }

  function openWhatsApp(phoneNumber) {
    if (!phoneNumber) return;

    // Clean phone number and ensure it starts with country code
    let cleanNumber = phoneNumber.replace(/[^\\d+]/g, '');

    // If number doesn't start with +, assume German number and add +49
    if (!cleanNumber.startsWith('+')) {
      if (cleanNumber.startsWith('0')) {
        cleanNumber = '+49' + cleanNumber.substring(1);
      } else {
        cleanNumber = '+49' + cleanNumber;
      }
    }

    // Create WhatsApp link
    const whatsappUrl = `https://wa.me/${cleanNumber.replace('+', '')}`;

    // Open WhatsApp
    window.open(whatsappUrl, '_blank');
  }

  function copyToClipboard(text) {
    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(text).then(() => {
        // Show temporary feedback
        const feedback = document.createElement('div');
        feedback.textContent = 'Nummer kopiert!';
        feedback.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-lg z-50 text-sm';
        document.body.appendChild(feedback);
        setTimeout(() => feedback.remove(), 2000);
      }).catch(() => {
        fallbackCopyTextToClipboard(text);
      });
    } else {
      fallbackCopyTextToClipboard(text);
    }
  }

  function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.top = "0";
    textArea.style.left = "0";
    textArea.style.position = "fixed";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    try {
      document.execCommand('copy');
      const feedback = document.createElement('div');
      feedback.textContent = 'Nummer kopiert!';
      feedback.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-lg z-50 text-sm';
      document.body.appendChild(feedback);
      setTimeout(() => feedback.remove(), 2000);
    } catch (err) {
      console.error('Fallback: Oops, unable to copy', err);
    }
    document.body.removeChild(textArea);
  }

  function showContactOptions(phoneNumber) {
    if (!phoneNumber) return;

    const options = confirm(`Telefonnummer: ${phoneNumber}\\n\\nOK = Anrufen\\nAbbrechen = WhatsApp`);

    if (options) {
      makePhoneCall(phoneNumber);
    } else {
      openWhatsApp(phoneNumber);
    }
  }

  function toggleTask(taskId) {
    const task = tasks.find(t => t.id === taskId);
    if (task) {
      task.completed = !task.completed;
      task.completedAt = task.completed ? new Date().toLocaleDateString('de-DE') : null;
      saveTasksToStorage();
      updateTaskDisplay();
    }
  }

  function editTask(taskId) {
    const task = tasks.find(t => t.id === taskId);
    if (!task) return;

    editingTaskId = taskId;

    // Hide add form if open
    hideTaskForm();

    // Fill edit form with current task data
    document.getElementById('editTaskName').value = task.name || '';
    document.getElementById('editTaskTitle').value = task.title;
    document.getElementById('editTaskLocation').value = task.location;
    document.getElementById('editTaskCustomerPrice').value = task.customerPrice || '';
    document.getElementById('editTaskSpareParts').value = task.spareParts || '';
    document.getElementById('editTaskPhone').value = task.phone || '';
    document.getElementById('editTaskDate').value = task.plannedDate || '';
    document.getElementById('editTaskPriority').value = task.priority;

    // Calculate and display earnings
    calculateEditEarnings();

    // Show edit form
    document.getElementById('editTaskForm').classList.remove('hidden');
    document.getElementById('editTaskName').focus();
  }

  function hideEditForm() {
    document.getElementById('editTaskForm').classList.add('hidden');
    editingTaskId = null;

    // Clear form
    document.getElementById('editTaskName').value = '';
    document.getElementById('editTaskTitle').value = '';
    document.getElementById('editTaskLocation').value = '';
    document.getElementById('editTaskCustomerPrice').value = '';
    document.getElementById('editTaskSpareParts').value = '';
    document.getElementById('editTaskPhone').value = '';
    document.getElementById('editTaskDate').value = '';
    document.getElementById('editTaskPriority').value = 'low';
    calculateEditEarnings();
  }

  async function saveEditedTask() {
    if (!editingTaskId) return;

    const name = document.getElementById('editTaskName').value.trim();
    const title = document.getElementById('editTaskTitle').value.trim();
    const location = document.getElementById('editTaskLocation').value.trim();
    const customerPrice = parseFloat(document.getElementById('editTaskCustomerPrice').value) || 0;
    const spareParts = parseFloat(document.getElementById('editTaskSpareParts').value) || 0;
    const phone = document.getElementById('editTaskPhone').value.trim();
    const plannedDate = document.getElementById('editTaskDate').value || null;
    const earnings = customerPrice - spareParts;
    const priority = document.getElementById('editTaskPriority').value;

    if (!name || !title || !location) {
      alert('Bitte fÃ¼llen Sie Name, Titel und Adresse aus!');
      return;
    }

    const task = tasks.find(t => t.id === editingTaskId);
    if (!task) return;

    // Check if location changed - if so, get new coordinates
    if (task.location !== location) {
      // Show loading state
      const saveBtn = document.getElementById('saveTaskBtn');
      const originalText = saveBtn.innerHTML;
      saveBtn.innerHTML = 'ğŸ”„ Suche Adresse...';
      saveBtn.disabled = true;

      try {
        const geocodeResult = await geocodeAddress(location);

        if (!geocodeResult) {
          alert('Adresse konnte nicht gefunden werden. Bitte Ã¼berprÃ¼fen Sie die Eingabe.');
          return;
        }

        // Update task with new coordinates
        task.coordinates = [geocodeResult.lat, geocodeResult.lng];
        task.fullAddress = geocodeResult.displayName;
      } catch (error) {
        alert('Fehler beim Suchen der Adresse. Bitte versuchen Sie es erneut.');
        return;
      } finally {
        // Reset button
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
      }
    }

    // Automatically set status to "planned" if a date is provided
    const finalPriority = plannedDate && priority !== 'high' ? 'medium' : priority;

    // Update task data
    task.name = name;
    task.title = title;
    task.location = location;
    task.customerPrice = customerPrice;
    task.spareParts = spareParts;
    task.phone = phone;
    task.plannedDate = plannedDate;
    task.earnings = earnings;
    task.priority = finalPriority;

    // Save to storage and update display
    saveTasksToStorage();
    hideEditForm();
    updateTaskDisplay();
  }

  function deleteTask(taskId) {
    if (confirm('Aufgabe wirklich lÃ¶schen?')) {
      tasks = tasks.filter(t => t.id !== taskId);
      saveTasksToStorage();
      updateTaskDisplay();
    }
  }

  function updateTaskDisplay() {
    if (currentView === 'list') {
      updateListView();
    } else if (currentView === 'map') {
      updateMapView();
    } else if (currentView === 'calendar') {
      updateCalendarView();
    } else if (currentView === 'stats') {
      updateStatsView();
    }
    updateTaskCount();
  }

  function changePeriod(direction) {
    if (calendarViewMode === 'month') {
      currentDate.setMonth(currentDate.getMonth() + direction);
    } else if (calendarViewMode === 'week') {
      currentDate.setDate(currentDate.getDate() + (direction * 7));
    } else if (calendarViewMode === 'day') {
      currentDate.setDate(currentDate.getDate() + direction);
    }
    updateCalendarView();
  }

  function switchCalendarView(mode) {
    calendarViewMode = mode;

    // Update button styles
    const monthBtn = document.getElementById('monthViewBtn');
    const weekBtn = document.getElementById('weekViewBtn');
    const dayBtn = document.getElementById('dayViewBtn');

    [monthBtn, weekBtn, dayBtn].forEach(btn => {
      btn.classList.remove('bg-blue-500', 'text-white');
      btn.classList.add('bg-blue-100', 'text-blue-600');
    });

    if (mode === 'month') {
      monthBtn.classList.remove('bg-blue-100', 'text-blue-600');
      monthBtn.classList.add('bg-blue-500', 'text-white');
    } else if (mode === 'week') {
      weekBtn.classList.remove('bg-blue-100', 'text-blue-600');
      weekBtn.classList.add('bg-blue-500', 'text-white');
    } else if (mode === 'day') {
      dayBtn.classList.remove('bg-blue-100', 'text-blue-600');
      dayBtn.classList.add('bg-blue-500', 'text-white');
    }

    updateCalendarView();
  }

  function updateCalendarView() {
    const monthNames = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni',
      'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
    const dayNames = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];

    // Hide all views first
    document.getElementById('monthView').classList.add('hidden');
    document.getElementById('weekView').classList.add('hidden');
    document.getElementById('dayView').classList.add('hidden');

    if (calendarViewMode === 'month') {
      document.getElementById('monthView').classList.remove('hidden');
      updateMonthView(monthNames);
    } else if (calendarViewMode === 'week') {
      document.getElementById('weekView').classList.remove('hidden');
      updateWeekView(monthNames);
    } else if (calendarViewMode === 'day') {
      document.getElementById('dayView').classList.remove('hidden');
      updateDayView(monthNames, dayNames);
    }

    // Update unplanned tasks
    updateUnplannedTasks();
  }

  function updateMonthView(monthNames) {
    document.getElementById('currentPeriod').textContent =
      `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - (firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1));

    const calendarGrid = document.getElementById('calendarGrid');
    calendarGrid.innerHTML = '';

    for (let i = 0; i < 42; i++) {
      const cellDate = new Date(startDate);
      cellDate.setDate(startDate.getDate() + i);

      const isCurrentMonth = cellDate.getMonth() === currentDate.getMonth();
      const isToday = cellDate.toDateString() === new Date().toDateString();
      const dateStr = cellDate.toISOString().split('T')[0];

      const dayTasks = tasks.filter(task => task.plannedDate === dateStr && !task.completed);

      const cell = document.createElement('div');
      cell.className = `min-h-[80px] border rounded p-1 ${isCurrentMonth ? 'bg-white' : 'bg-gray-100'} ${isToday ? 'ring-2 ring-blue-500' : ''}`;
      cell.setAttribute('data-date', dateStr);

      cell.innerHTML = `
                <div class="text-xs font-bold mb-1 ${isCurrentMonth ? 'text-gray-900' : 'text-gray-400'}">${cellDate.getDate()}</div>
                <div class="space-y-1" id="tasks-${dateStr}">
                    ${dayTasks.map(task => createTaskElement(task, true)).join('')}
                </div>
            `;

      // Add drop functionality
      cell.addEventListener('dragover', handleDragOver);
      cell.addEventListener('drop', handleDrop);
      cell.addEventListener('dragleave', (e) => e.currentTarget.classList.remove('bg-blue-50'));

      // Add touch events for mobile
      cell.addEventListener('touchstart', (e) => e.preventDefault());
      cell.addEventListener('touchmove', (e) => e.preventDefault());
      cell.addEventListener('touchend', (e) => e.preventDefault());

      calendarGrid.appendChild(cell);
    }
  }

  function updateWeekView(monthNames) {
    // Get start of week (Monday)
    const startOfWeek = new Date(currentDate);
    const day = startOfWeek.getDay();
    const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1);
    startOfWeek.setDate(diff);

    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);

    // Update header
    if (startOfWeek.getMonth() === endOfWeek.getMonth()) {
      document.getElementById('currentPeriod').textContent =
        `${startOfWeek.getDate()}-${endOfWeek.getDate()} ${monthNames[startOfWeek.getMonth()]} ${startOfWeek.getFullYear()}`;
    } else {
      document.getElementById('currentPeriod').textContent =
        `${startOfWeek.getDate()} ${monthNames[startOfWeek.getMonth()]} - ${endOfWeek.getDate()} ${monthNames[endOfWeek.getMonth()]} ${startOfWeek.getFullYear()}`;
    }

    const weekGrid = document.getElementById('weekGrid');
    weekGrid.innerHTML = '';

    for (let i = 0; i < 7; i++) {
      const cellDate = new Date(startOfWeek);
      cellDate.setDate(startOfWeek.getDate() + i);

      const isToday = cellDate.toDateString() === new Date().toDateString();
      const dateStr = cellDate.toISOString().split('T')[0];

      const dayTasks = tasks.filter(task => task.plannedDate === dateStr && !task.completed);

      const cell = document.createElement('div');
      cell.className = `min-h-[120px] border rounded p-2 bg-white ${isToday ? 'ring-2 ring-blue-500' : ''}`;
      cell.setAttribute('data-date', dateStr);

      cell.innerHTML = `
                <div class="text-sm font-bold mb-2 text-gray-900">${cellDate.getDate()}</div>
                <div class="space-y-1" id="tasks-${dateStr}">
                    ${dayTasks.map(task => createTaskElement(task, true)).join('')}
                </div>
            `;

      // Add drop functionality
      cell.addEventListener('dragover', handleDragOver);
      cell.addEventListener('drop', handleDrop);
      cell.addEventListener('dragleave', (e) => e.currentTarget.classList.remove('bg-blue-50'));

      // Add touch events for mobile
      cell.addEventListener('touchstart', (e) => e.preventDefault());
      cell.addEventListener('touchmove', (e) => e.preventDefault());
      cell.addEventListener('touchend', (e) => e.preventDefault());

      weekGrid.appendChild(cell);
    }
  }

  function updateDayView(monthNames, dayNames) {
    const dayName = dayNames[currentDate.getDay()];
    document.getElementById('currentPeriod').textContent =
      `${dayName}, ${currentDate.getDate()} ${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

    const dateStr = currentDate.toISOString().split('T')[0];
    const dayTasks = tasks.filter(task => task.plannedDate === dateStr && !task.completed);

    const dayContainer = document.getElementById('dayContainer');
    dayContainer.setAttribute('data-date', dateStr);

    if (dayTasks.length === 0) {
      dayContainer.innerHTML = `
                <div class="text-center py-16 text-gray-500">
                    <div class="bg-gray-50 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-6">
                        <div class="text-3xl">ğŸ“…</div>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Keine Aufgaben fÃ¼r diesen Tag</h3>
                    <p class="text-sm text-gray-500 mb-4">Ziehen Sie Aufgaben aus der ungeplanten Liste hierher</p>
                    <div class="bg-blue-50 border-2 border-dashed border-blue-200 rounded-lg p-4 text-blue-600">
                        <span class="text-2xl">ğŸ”„</span>
                        <p class="text-sm mt-2">Drag & Drop Zone</p>
                    </div>
                </div>
            `;
    } else {
      dayContainer.innerHTML = `
                <h4 class="font-bold mb-4 text-lg">ğŸ“‹ Aufgaben fÃ¼r heute (${dayTasks.length})</h4>
                <div class="space-y-3">
                    ${dayTasks.map(task => createDetailedTaskElement(task)).join('')}
                </div>
            `;
    }

    // Add drop functionality
    dayContainer.addEventListener('dragover', handleDragOver);
    dayContainer.addEventListener('drop', handleDrop);
    dayContainer.addEventListener('dragleave', (e) => e.currentTarget.classList.remove('bg-blue-50'));
  }

  function createDetailedTaskElement(task) {
    const priorityColors = {
      low: 'border-l-blue-500',
      medium: 'border-l-green-500',
      high: 'border-l-red-500'
    };

    const priorityIcons = {
      low: 'ğŸ”µ',
      medium: 'ğŸŸ¢',
      high: 'ğŸ”´'
    };

    return `
            <div class="bg-white border-l-4 ${priorityColors[task.priority]} rounded-xl p-5 shadow-md hover:shadow-lg transition-shadow duration-200 ${task.completed ? 'opacity-75' : ''}">
                <!-- Header -->
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center space-x-3 flex-1">
                        <button onclick="toggleTask(${task.id}); updateCalendarView();"
                                class="w-6 h-6 rounded-full border-2 ${task.completed ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 hover:border-blue-400'} flex items-center justify-center transition-colors duration-200 flex-shrink-0">
                            ${task.completed ? 'âœ“' : ''}
                        </button>
                        <h3 class="text-lg font-semibold ${task.completed ? 'line-through text-gray-500' : 'text-gray-900'} leading-tight">${task.title}</h3>
                    </div>
                    <div class="flex items-center space-x-2 ml-4">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${task.priority === 'high' ? 'bg-red-100 text-red-700' : task.priority === 'medium' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">
                            ${priorityIcons[task.priority]} ${task.priority === 'low' ? 'Offen' : task.priority === 'medium' ? 'Geplant' : 'Dringend'}
                        </span>
                        <button onclick="editTask(${task.id})"
                                class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg transition-colors duration-200" title="Bearbeiten">
                            âœï¸
                        </button>
                    </div>
                </div>

                <!-- Adresse und Kontakt -->
                <div class="bg-gray-50 rounded-lg p-3 mb-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2 text-gray-700">
                            <span class="text-blue-500">ğŸ“</span>
                            <span class="font-medium">${task.location}</span>
                        </div>
                        ${task.phone ? `
                        <button onclick="showContactOptions('${task.phone}')"
                                class="flex items-center space-x-1 px-3 py-1 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors duration-200 text-sm">
                            <span>ğŸ“</span>
                            <span>${task.phone}</span>
                        </button>
                        ` : ''}
                    </div>
                </div>

                <!-- Finanzielle Informationen -->
                ${task.customerPrice > 0 || task.spareParts > 0 || task.earnings !== 0 ? `
                <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-3 mb-4">
                    <div class="grid grid-cols-3 gap-3 text-center">
                        ${task.customerPrice > 0 ? `
                        <div class="bg-white rounded-lg p-2">
                            <div class="text-xs text-gray-500 mb-1">Kundenpreis</div>
                            <div class="font-bold text-green-600">ğŸ’° ${task.customerPrice.toFixed(2)} â‚¬</div>
                        </div>
                        ` : '<div></div>'}
                        ${task.spareParts > 0 ? `
                        <div class="bg-white rounded-lg p-2">
                            <div class="text-xs text-gray-500 mb-1">Ersatzteile</div>
                            <div class="font-bold text-orange-600">ğŸ”§ ${task.spareParts.toFixed(2)} â‚¬</div>
                        </div>
                        ` : '<div></div>'}
                        ${task.earnings !== 0 ? `
                        <div class="bg-white rounded-lg p-2">
                            <div class="text-xs text-gray-500 mb-1">Einnahmen</div>
                            <div class="font-bold text-${task.earnings >= 0 ? 'green' : 'red'}-600">ğŸ“ˆ ${task.earnings.toFixed(2)} â‚¬</div>
                        </div>
                        ` : '<div></div>'}
                    </div>
                </div>
                ` : ''}

                <!-- Aktionen -->
                <div class="flex items-center justify-between">
                    <button onclick="openNavigation([${task.coordinates[0]}, ${task.coordinates[1]}], '${task.location}')"
                            class="flex items-center space-x-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200 font-medium">
                        <span>ğŸ§­</span>
                        <span>Navigation</span>
                    </button>

                    <button onclick="unplanTask(${task.id})"
                            class="flex items-center space-x-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors duration-200 font-medium">
                        <span>âŒ</span>
                        <span>Entfernen</span>
                    </button>
                </div>
            </div>
        `;
  }

  function setTaskFilter(filter) {
    currentFilter = filter;

    // Update button styles
    const allBtn = document.getElementById('allTasksBtn');
    const openBtn = document.getElementById('openTasksBtn');
    const plannedBtn = document.getElementById('plannedTasksBtn');
    const urgentBtn = document.getElementById('urgentTasksBtn');
    const completedBtn = document.getElementById('completedTasksBtn');

    [allBtn, openBtn, plannedBtn, urgentBtn, completedBtn].forEach(btn => {
      btn.classList.remove('bg-blue-500', 'text-white');
      btn.classList.add('bg-blue-100', 'text-blue-600');
    });

    if (filter === 'all') {
      allBtn.classList.remove('bg-blue-100', 'text-blue-600');
      allBtn.classList.add('bg-blue-500', 'text-white');
    } else if (filter === 'open') {
      openBtn.classList.remove('bg-blue-100', 'text-blue-600');
      openBtn.classList.add('bg-blue-500', 'text-white');
    } else if (filter === 'planned') {
      plannedBtn.classList.remove('bg-blue-100', 'text-blue-600');
      plannedBtn.classList.add('bg-blue-500', 'text-white');
    } else if (filter === 'urgent') {
      urgentBtn.classList.remove('bg-blue-100', 'text-blue-600');
      urgentBtn.classList.add('bg-blue-500', 'text-white');
    } else if (filter === 'completed') {
      completedBtn.classList.remove('bg-blue-100', 'text-blue-600');
      completedBtn.classList.add('bg-blue-500', 'text-white');
    }

    updateListView();
  }

  function getFilteredTasks() {
    if (currentFilter === 'all') {
      return tasks.filter(task => !task.completed);
    } else if (currentFilter === 'open') {
      return tasks.filter(task => !task.completed && task.priority === 'low');
    } else if (currentFilter === 'planned') {
      return tasks.filter(task => !task.completed && task.priority === 'medium');
    } else if (currentFilter === 'urgent') {
      return tasks.filter(task => !task.completed && task.priority === 'high');
    } else if (currentFilter === 'completed') {
      return tasks.filter(task => task.completed);
    }
    return tasks;
  }

  function updateUnplannedTasks() {
    const unplannedTasks = tasks.filter(task => !task.plannedDate && !task.completed);
    const container = document.getElementById('unplannedTasks');
    const counter = document.getElementById('unplannedCount');

    if (counter) {
      counter.textContent = unplannedTasks.length;
    }

    if (unplannedTasks.length === 0) {
      container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <div class="bg-green-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl">âœ…</span>
                    </div>
                    <p class="font-medium text-gray-700">Alle Aufgaben sind geplant!</p>
                    <p class="text-sm text-gray-500 mt-1">GroÃŸartig! Ihre Planung ist vollstÃ¤ndig.</p>
                </div>
            `;
    } else {
      container.innerHTML = unplannedTasks.map(task => createUnplannedTaskElement(task)).join('');
    }
  }

  function createUnplannedTaskElement(task) {
    const priorityColors = {
      low: 'bg-blue-50 border-blue-200 hover:bg-blue-100',
      medium: 'bg-green-50 border-green-200 hover:bg-green-100',
      high: 'bg-red-50 border-red-200 hover:bg-red-100'
    };

    return `
            <div class="task-item ${priorityColors[task.priority]} border-2 rounded-lg p-3 cursor-move text-sm transition-colors duration-200 ${task.completed ? 'opacity-60' : ''}"
                 draggable="true"
                 data-task-id="${task.id}"
                 ondragstart="handleDragStart(event)"
                 ontouchstart="handleTouchStart(event)"
                 ontouchmove="handleTouchMove(event)"
                 ontouchend="handleTouchEnd(event)"
                 onclick="openTaskModal(${task.id})">
                <div class="flex items-start space-x-3">
                    <button onclick="event.stopPropagation(); toggleTask(${task.id}); updateCalendarView();"
                            class="w-5 h-5 rounded-full border-2 ${task.completed ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 hover:border-blue-400'} flex items-center justify-center text-xs mt-0.5 transition-colors duration-200 flex-shrink-0">
                        ${task.completed ? 'âœ“' : ''}
                    </button>
                    <div class="flex-1 min-w-0">
                        <div class="font-semibold truncate ${task.completed ? 'line-through text-gray-500' : 'text-gray-900'} mb-1">${task.name || task.title}</div>
                        <div class="flex items-center text-gray-600 mb-2">
                            <span class="text-blue-500 mr-1">ğŸ“</span>
                            <span class="truncate text-xs">${task.location}</span>
                        </div>

                        ${task.phone ? `
                        <button onclick="event.stopPropagation(); copyToClipboard('${task.phone}')"
                                class="flex items-center space-x-1 px-2 py-1 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors duration-200 text-xs mb-2">
                            <span>ğŸ“</span>
                            <span class="truncate">${task.phone}</span>
                        </button>
                        ` : ''}

                        <div class="flex items-center justify-between text-xs">
                            ${task.customerPrice > 0 || task.earnings !== 0 ? `
                            <div class="flex items-center space-x-2">
                                ${task.customerPrice > 0 ? `<span class="text-green-600 font-medium">ğŸ’° ${task.customerPrice.toFixed(2)}â‚¬</span>` : ''}
                                ${task.earnings !== 0 ? `<span class="text-${task.earnings >= 0 ? 'green' : 'red'}-600 font-medium">ğŸ“ˆ ${task.earnings.toFixed(2)}â‚¬</span>` : ''}
                            </div>
                            ` : '<div></div>'}

                            ${task.completed ? '<span class="text-green-600 font-medium">âœ… Erledigt</span>' : '<span class="text-gray-400">ğŸ”„ Ziehen zum Planen</span>'}
                        </div>
                    </div>
                </div>
            </div>
        `;
  }

  function createTaskElement(task, isPlanned) {
    const priorityColors = {
      low: 'bg-blue-50 border-blue-200 hover:bg-blue-100',
      medium: 'bg-green-50 border-green-200 hover:bg-green-100',
      high: 'bg-red-50 border-red-200 hover:bg-red-100'
    };

    return `
            <div class="task-item ${priorityColors[task.priority]} border-2 rounded-lg p-2 cursor-move text-xs transition-colors duration-200 ${task.completed ? 'opacity-60' : ''}"
                 draggable="true"
                 data-task-id="${task.id}"
                 ondragstart="handleDragStart(event)"
                 ontouchstart="handleTouchStart(event)"
                 ontouchmove="handleTouchMove(event)"
                 ontouchend="handleTouchEnd(event)"
                 onclick="openTaskModal(${task.id})">
                <div class="font-semibold truncate ${task.completed ? 'line-through text-gray-500' : 'text-gray-900'} mb-1">${task.name || task.title}</div>

                ${isPlanned ? `
                <button onclick="event.stopPropagation(); unplanTask(${task.id})"
                        class="w-full text-center text-red-500 hover:text-red-700 font-medium mt-1 py-1 hover:bg-red-50 rounded transition-colors duration-200">
                    âŒ Entfernen
                </button>
                ` : ''}
            </div>
        `;
  }

  function handleDragStart(event) {
    draggedTask = parseInt(event.target.getAttribute('data-task-id'));
    event.dataTransfer.effectAllowed = 'move';
  }

  function handleDragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
    event.currentTarget.classList.add('bg-blue-50');
  }

  function handleDrop(event) {
    event.preventDefault();
    event.currentTarget.classList.remove('bg-blue-50');

    if (draggedTask) {
      const targetDate = event.currentTarget.getAttribute('data-date');
      const task = tasks.find(t => t.id === draggedTask);

      if (task) {
        task.plannedDate = targetDate;
        // Automatically set status to "planned" when task gets a date
        if (task.priority !== 'high') { // Don't change urgent tasks
          task.priority = 'medium';
        }
        saveTasksToStorage();
        updateCalendarView();
      }

      draggedTask = null;
    }
  }

  // Touch event handlers for mobile
  let touchStartX, touchStartY, touchElement, touchClone;

  function handleTouchStart(event) {
    const touch = event.touches[0];
    touchStartX = touch.clientX;
    touchStartY = touch.clientY;
    touchElement = event.currentTarget;
    draggedTask = parseInt(touchElement.getAttribute('data-task-id'));

    // Create visual feedback
    touchElement.style.opacity = '0.7';
    touchElement.style.transform = 'scale(1.05)';

    event.preventDefault();
  }

  function handleTouchMove(event) {
    if (!touchElement) return;

    const touch = event.touches[0];
    const deltaX = touch.clientX - touchStartX;
    const deltaY = touch.clientY - touchStartY;

    // Move the element
    touchElement.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(1.05)`;
    touchElement.style.zIndex = '1000';

    // Find element under touch
    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    const dropZone = elementBelow?.closest('[data-date]');

    // Visual feedback for drop zones
    document.querySelectorAll('[data-date]').forEach(zone => {
      zone.classList.remove('bg-blue-50');
    });

    if (dropZone && dropZone !== touchElement.closest('[data-date]')) {
      dropZone.classList.add('bg-blue-50');
    }

    event.preventDefault();
  }

  function handleTouchEnd(event) {
    if (!touchElement) return;

    const touch = event.changedTouches[0];
    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    const dropZone = elementBelow?.closest('[data-date]');

    // Reset visual state
    touchElement.style.opacity = '';
    touchElement.style.transform = '';
    touchElement.style.zIndex = '';

    // Remove all drop zone highlights
    document.querySelectorAll('[data-date]').forEach(zone => {
      zone.classList.remove('bg-blue-50');
    });

    // Handle drop
    if (dropZone && draggedTask) {
      const targetDate = dropZone.getAttribute('data-date');
      const task = tasks.find(t => t.id === draggedTask);

      if (task && targetDate !== task.plannedDate) {
        task.plannedDate = targetDate;
        // Automatically set status to "planned" when task gets a date
        if (task.priority !== 'high') { // Don't change urgent tasks
          task.priority = 'medium';
        }
        saveTasksToStorage();
        updateCalendarView();
      }
    }

    // Reset touch state
    touchElement = null;
    draggedTask = null;
    touchStartX = null;
    touchStartY = null;

    event.preventDefault();
  }

  function unplanTask(taskId) {
    const task = tasks.find(t => t.id === taskId);
    if (task) {
      task.plannedDate = null;
      // Automatically set status back to "open" when removing date (unless urgent)
      if (task.priority === 'medium') {
        task.priority = 'low';
      }
      saveTasksToStorage();
      updateCalendarView();
    }
  }

  function updateListView() {
    const taskList = document.getElementById('taskList');
    const emptyState = document.getElementById('emptyState');

    const filteredTasks = getFilteredTasks();

    if (filteredTasks.length === 0) {
      taskList.innerHTML = '';

      // Show appropriate empty state message
      let emptyMessage = '';
      let emptyIcon = '';

      if (currentFilter === 'all') {
        emptyMessage = 'Keine offenen Aufgaben vorhanden';
        emptyIcon = 'ğŸ“';
      } else if (currentFilter === 'open') {
        emptyMessage = 'Keine offenen Aufgaben vorhanden';
        emptyIcon = 'ğŸ”µ';
      } else if (currentFilter === 'planned') {
        emptyMessage = 'Keine geplanten Aufgaben vorhanden';
        emptyIcon = 'ğŸŸ¢';
      } else if (currentFilter === 'urgent') {
        emptyMessage = 'Keine dringenden Aufgaben vorhanden';
        emptyIcon = 'ğŸ”´';
      } else if (currentFilter === 'completed') {
        emptyMessage = 'Keine erledigten Aufgaben vorhanden';
        emptyIcon = 'âœ…';
      }

      emptyState.innerHTML = `
                <div class="text-center py-16 text-gray-500">
                    <div class="bg-gray-50 rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-6">
                        <div class="text-4xl">${emptyIcon}</div>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">${emptyMessage}</h3>
                    <p class="text-sm text-gray-500 mb-6">FÃ¼gen Sie Ihre erste Aufgabe hinzu und beginnen Sie mit der Planung!</p>
                    ${currentFilter !== 'completed' ? `
                    <button onclick="document.getElementById('toggleFormBtn').click()"
                            class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200 font-medium">
                        â• Erste Aufgabe erstellen
                    </button>
                    ` : ''}
                </div>
            `;
      emptyState.style.display = 'block';
      return;
    }

    emptyState.style.display = 'none';

    taskList.innerHTML = filteredTasks.map(task => {
      const priorityColors = {
        low: 'border-l-blue-500',
        medium: 'border-l-green-500',
        high: 'border-l-red-500'
      };

      const priorityIcons = {
        low: 'ğŸ”µ',
        medium: 'ğŸŸ¢',
        high: 'ğŸ”´'
      };

      return `
                <div class="bg-white border-l-4 ${priorityColors[task.priority]} rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-200 ${task.completed ? 'opacity-75' : ''}">
                    <!-- Compact Header -->
                    <div class="p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-3 flex-1">
                                <button onclick="toggleTask(${task.id})"
                                        class="w-6 h-6 rounded-full border-2 ${task.completed ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 hover:border-blue-400'} flex items-center justify-center transition-colors duration-200 flex-shrink-0">
                                    ${task.completed ? 'âœ“' : ''}
                                </button>
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <h3 class="text-lg font-semibold ${task.completed ? 'line-through text-gray-500' : 'text-gray-900'} leading-tight">${task.name || task.title}</h3>
                                        <span class="px-2 py-1 text-xs font-medium rounded-full ${task.priority === 'high' ? 'bg-red-100 text-red-700' : task.priority === 'medium' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">
                                            ${priorityIcons[task.priority]} ${task.priority === 'low' ? 'Offen' : task.priority === 'medium' ? 'Geplant' : 'Dringend'}
                                        </span>
                                    </div>
                                    ${task.name ? `<p class="text-sm text-gray-600">${task.title}</p>` : ''}
                                </div>
                            </div>
                            <div class="flex items-center space-x-1">
                                <button onclick="editTask(${task.id})"
                                        class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg transition-colors duration-200" title="Bearbeiten">
                                    âœï¸
                                </button>
                                <button onclick="toggleTaskDetails(${task.id})"
                                        class="p-2 text-gray-400 hover:text-gray-600 transition-colors duration-200"
                                        id="expand-btn-${task.id}">
                                    â–¼
                                </button>
                            </div>
                        </div>

                        <!-- Basic Info -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2 text-gray-700 flex-1">
                                <span class="text-blue-500">ğŸ“</span>
                                <span class="font-medium truncate">${task.location.split(',').slice(-2)[0]?.trim() || task.location.split(',')[0]}</span>
                            </div>

                            <div class="flex items-center space-x-2 ml-4">
                                ${task.phone ? `
                                <button onclick="copyToClipboard('${task.phone}')"
                                        class="flex items-center space-x-1 px-2 py-1 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors duration-200 text-xs">
                                    <span>ğŸ“</span>
                                    <span>${task.phone}</span>
                                </button>
                                ` : ''}

                                <button onclick="openNavigation([${task.coordinates[0]}, ${task.coordinates[1]}], '${task.location}')"
                                        class="flex items-center space-x-1 px-3 py-1 bg-green-500 text-white rounded-full hover:bg-green-600 transition-colors duration-200 text-xs">
                                    <span>ğŸ§­</span>
                                    <span>Navigation</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Expandable Details -->
                    <div id="details-${task.id}" class="hidden border-t border-gray-100 p-4 bg-gray-50">
                        <!-- Priority Badge -->
                        <div class="mb-4">
                            <span class="px-3 py-1 text-sm font-medium rounded-full ${task.priority === 'high' ? 'bg-red-100 text-red-700' : task.priority === 'medium' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">
                                ${priorityIcons[task.priority]} ${task.priority === 'low' ? 'Offen' : task.priority === 'medium' ? 'Geplant' : 'Dringend'}
                            </span>
                        </div>

                        <!-- Finanzielle Informationen -->
                        ${task.customerPrice > 0 || task.spareParts > 0 || task.earnings !== 0 ? `
                        <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-3 mb-4">
                            <div class="grid grid-cols-3 gap-3 text-center">
                                ${task.customerPrice > 0 ? `
                                <div class="bg-white rounded-lg p-2">
                                    <div class="text-xs text-gray-500 mb-1">Kundenpreis</div>
                                    <div class="font-bold text-green-600">ğŸ’° ${task.customerPrice.toFixed(2)} â‚¬</div>
                                </div>
                                ` : '<div></div>'}
                                ${task.spareParts > 0 ? `
                                <div class="bg-white rounded-lg p-2">
                                    <div class="text-xs text-gray-500 mb-1">Ersatzteile</div>
                                    <div class="font-bold text-orange-600">ğŸ”§ ${task.spareParts.toFixed(2)} â‚¬</div>
                                </div>
                                ` : '<div></div>'}
                                ${task.earnings !== 0 ? `
                                <div class="bg-white rounded-lg p-2">
                                    <div class="text-xs text-gray-500 mb-1">Einnahmen</div>
                                    <div class="font-bold text-${task.earnings >= 0 ? 'green' : 'red'}-600">ğŸ“ˆ ${task.earnings.toFixed(2)} â‚¬</div>
                                </div>
                                ` : '<div></div>'}
                            </div>
                        </div>
                        ` : ''}

                        <!-- Zeitstempel -->
                        <div class="flex items-center justify-between text-xs text-gray-400 mb-4 bg-white rounded-lg p-2">
                            <span>ğŸ“… Erstellt: ${task.createdAt}</span>
                            ${task.plannedDate ? `<span class="text-blue-500">ğŸ“‹ Geplant: ${new Date(task.plannedDate).toLocaleDateString('de-DE')}</span>` : ''}
                            ${task.completedAt ? `<span class="text-green-500">âœ… Erledigt: ${task.completedAt}</span>` : ''}
                        </div>

                        <!-- Aktionen -->
                        <div class="flex items-center justify-end">
                            <button onclick="deleteTask(${task.id})"
                                    class="p-1.5 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition-colors duration-200 text-sm" title="LÃ¶schen">
                                ğŸ—‘ï¸
                            </button>
                        </div>

                        ${task.fullAddress ? `
                        <div class="mt-3 pt-3 border-t border-gray-200">
                            <div class="text-xs text-gray-500 flex items-start space-x-2">
                                <span class="text-gray-400">ğŸ </span>
                                <span class="leading-relaxed">${task.fullAddress}</span>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
    }).join('');
  }

  function toggleTaskDetails(taskId) {
    const details = document.getElementById(`details-${taskId}`);
    const button = document.getElementById(`expand-btn-${taskId}`);

    if (details.classList.contains('hidden')) {
      details.classList.remove('hidden');
      button.textContent = 'â–²';
    } else {
      details.classList.add('hidden');
      button.textContent = 'â–¼';
    }
  }

  function updateMapView() {
    if (!map) return;

    // Clear existing markers
    map.eachLayer(layer => {
      if (layer instanceof L.Marker) {
        map.removeLayer(layer);
      }
    });

    // Add markers for each task (exclude completed tasks)
    tasks.filter(task => !task.completed).forEach(task => {
      if (task.coordinates) {
        const markerColor = task.priority === 'high' ? '#ef4444' : // rot = dringend
          task.plannedDate ? '#10b981' : // grÃ¼n = geplant
            '#3b82f6'; // blau = offen

        const marker = L.circleMarker(task.coordinates, {
          radius: 8,
          fillColor: markerColor,
          color: 'white',
          weight: 2,
          opacity: 1,
          fillOpacity: 0.8
        }).addTo(map);

        const popupContent = `
                    <div class="p-2">
                        <h4 class="font-bold text-sm mb-1">${task.title}</h4>
                        <p class="text-xs text-gray-600 mb-2">ğŸ“ ${task.location}</p>
                        ${task.phone ? `<button onclick="showContactOptions('${task.phone}')" class="text-xs text-blue-600 hover:text-blue-800 mb-2 block">ğŸ“ ${task.phone}</button>` : ''}
                        ${task.customerPrice > 0 ? `<p class="text-xs text-gray-600 mb-1">ğŸ’° Kundenpreis: ${task.customerPrice.toFixed(2)} â‚¬</p>` : ''}
                        ${task.spareParts > 0 ? `<p class="text-xs text-gray-600 mb-1">ğŸ”§ Ersatzteile: ${task.spareParts.toFixed(2)} â‚¬</p>` : ''}
                        ${task.earnings !== 0 ? `<p class="text-xs text-${task.earnings >= 0 ? 'green' : 'red'}-600 mb-2">ğŸ“ˆ Einnahmen: ${task.earnings.toFixed(2)} â‚¬</p>` : ''}
                        ${task.fullAddress ? `<p class="text-xs text-gray-500 mb-2">${task.fullAddress}</p>` : ''}
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs ${task.completed ? 'text-green-600' : 'text-gray-500'}">
                                ${task.completed ? 'âœ… Erledigt' : 'â³ Offen'}
                                ${task.completedAt ? ` (${task.completedAt})` : ''}
                            </span>
                            <button onclick="toggleTask(${task.id}); updateMapView();"
                                    class="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                                ${task.completed ? 'RÃ¼ckgÃ¤ngig' : 'Erledigen'}
                            </button>
                        </div>
                        <button onclick="openNavigation([${task.coordinates[0]}, ${task.coordinates[1]}], '${task.location}')"
                                class="w-full text-xs px-2 py-1 bg-green-500 text-white rounded hover:bg-green-600">
                            ğŸ§­ Navigation starten
                        </button>
                    </div>
                `;

        marker.bindPopup(popupContent);
      }
    });

    // Fit map to show all markers
    if (tasks.length > 0) {
      const group = new L.featureGroup(map._layers);
      if (Object.keys(group._layers).length > 0) {
        map.fitBounds(group.getBounds().pad(0.1));
      }
    }
  }

  function updateStatsView() {
    const completedTasks = tasks.filter(t => t.completed);
    const totalEarnings = completedTasks.reduce((sum, task) => sum + task.earnings, 0);

    // Update total earnings
    document.getElementById('totalCosts').textContent = totalEarnings.toFixed(2) + ' â‚¬';

    // Calculate monthly statistics
    const monthlyData = {};
    completedTasks.forEach(task => {
      if (task.completedAt) {
        const [day, month, year] = task.completedAt.split('.');
        const monthKey = `${month}.${year}`;
        if (!monthlyData[monthKey]) {
          monthlyData[monthKey] = { count: 0, earnings: 0 };
        }
        monthlyData[monthKey].count++;
        monthlyData[monthKey].earnings += task.earnings;
      }
    });

    // Display monthly stats
    const monthlyStatsDiv = document.getElementById('monthlyStats');
    if (Object.keys(monthlyData).length === 0) {
      monthlyStatsDiv.innerHTML = '<p class="text-gray-500 text-sm">Noch keine erledigten Aufgaben</p>';
    } else {
      monthlyStatsDiv.innerHTML = Object.entries(monthlyData)
      .sort(([a], [b]) => b.localeCompare(a))
      .map(([month, data]) => `
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span class="font-medium">${month}</span>
                        <div class="text-right">
                            <div class="font-bold ${data.earnings >= 0 ? 'text-green-600' : 'text-red-600'}">${data.earnings.toFixed(2)} â‚¬</div>
                            <div class="text-xs text-gray-500">${data.count} Aufgaben</div>
                        </div>
                    </div>
                `).join('');
    }

    // Update task counts
    document.getElementById('openTasks').textContent = tasks.filter(t => !t.completed).length;
    document.getElementById('completedTasks').textContent = completedTasks.length;
  }

  function switchView(view) {
    currentView = view;

    const listView = document.getElementById('listView');
    const mapView = document.getElementById('mapView');
    const calendarView = document.getElementById('calendarView');
    const statsView = document.getElementById('statsView');
    const listBtn = document.getElementById('listViewBtn');
    const mapBtn = document.getElementById('mapViewBtn');
    const calendarBtn = document.getElementById('calendarViewBtn');
    const statsBtn = document.getElementById('statsViewBtn');

    // Hide all views
    listView.classList.add('hidden');
    mapView.classList.add('hidden');
    calendarView.classList.add('hidden');
    statsView.classList.add('hidden');

    // Reset button styles
    [listBtn, mapBtn, calendarBtn, statsBtn].forEach(btn => {
      btn.classList.remove('bg-blue-500', 'text-white');
      btn.classList.add('bg-blue-100', 'text-blue-600');
    });

    if (view === 'list') {
      listView.classList.remove('hidden');
      listBtn.classList.remove('bg-blue-100', 'text-blue-600');
      listBtn.classList.add('bg-blue-500', 'text-white');
      updateListView();
    } else if (view === 'map') {
      mapView.classList.remove('hidden');
      mapBtn.classList.remove('bg-blue-100', 'text-blue-600');
      mapBtn.classList.add('bg-blue-500', 'text-white');
      setTimeout(() => {
        map.invalidateSize();
        updateMapView();
      }, 100);
    } else if (view === 'calendar') {
      calendarView.classList.remove('hidden');
      calendarBtn.classList.remove('bg-blue-100', 'text-blue-600');
      calendarBtn.classList.add('bg-blue-500', 'text-white');
      updateCalendarView();
    } else if (view === 'stats') {
      statsView.classList.remove('hidden');
      statsBtn.classList.remove('bg-blue-100', 'text-blue-600');
      statsBtn.classList.add('bg-blue-500', 'text-white');
      updateStatsView();
    }
  }

  function updateTaskCount() {
    const openTasks = tasks.filter(t => !t.completed).length;
    const completed = tasks.filter(t => t.completed).length;
    document.getElementById('taskCount').textContent = `${openTasks} offene Aufgaben (${completed} erledigt)`;
  }

  function openTaskModal(taskId) {
    const task = tasks.find(t => t.id === taskId);
    if (!task) return;

    const priorityColors = {
      low: 'border-l-blue-500',
      medium: 'border-l-green-500',
      high: 'border-l-red-500'
    };

    const priorityIcons = {
      low: 'ğŸ”µ',
      medium: 'ğŸŸ¢',
      high: 'ğŸ”´'
    };

    const modalContent = `
            <div class="bg-white border-l-4 ${priorityColors[task.priority]} rounded-xl p-5 ${task.completed
      ? 'opacity-75' : ''}">
                <!-- Header -->
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center space-x-3 flex-1">
                        <button onclick="toggleTaskFromModal(${task.id})"
                                class="w-6 h-6 rounded-full border-2 ${task.completed
      ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 hover:border-blue-400'} flex items-center justify-center transition-colors duration-200 flex-shrink-0">
                            ${task.completed ? 'âœ“' : ''}
                        </button>
                        <h3 class="text-lg font-semibold ${task.completed
      ? 'line-through text-gray-500' : 'text-gray-900'} leading-tight">${task.name || task.title}</h3>
                    </div>
                    <button onclick="closeTaskModal()"
                            class="p-2 text-gray-400 hover:text-gray-600 transition-colors duration-200">
                        âœ•
                    </button>
                </div>

                ${task.name && task.title !== task.name ? `
                <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                    <div class="text-sm text-gray-600 mb-1">Aufgabe:</div>
                    <div class="font-medium text-gray-900">${task.title}</div>
                </div>
                ` : ''}

                <!-- Status Badge -->
                <div class="mb-4">
                    <span class="px-3 py-1 text-sm font-medium rounded-full ${task.priority
    === 'high' ? 'bg-red-100 text-red-700' : task.priority === 'medium'
      ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">
                        ${priorityIcons[task.priority]} ${task.priority === 'low' ? 'Offen'
      : task.priority === 'medium' ? 'Geplant' : 'Dringend'}
                    </span>
                    ${task.completed
      ? '<span class="ml-2 px-3 py-1 text-sm font-medium rounded-full bg-green-100 text-green-700">âœ… Erledigt</span>'
      : ''}
                </div>

                <!-- Adresse und Kontakt -->
                <div class="bg-gray-50 rounded-lg p-3 mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2 text-gray-700">
                            <span class="text-blue-500">ğŸ“</span>
                            <span class="font-medium">${task.location}</span>
                        </div>
                    </div>
                    ${task.fullAddress ? `
                    <div class="text-xs text-gray-500 mt-2 pl-6">
                        ${task.fullAddress}
                    </div>
                    ` : ''}
                    ${task.phone ? `
                    <div class="flex items-center space-x-2 mt-3">
                        <button onclick="makePhoneCall('${task.phone}')"
                                class="flex items-center space-x-1 px-3 py-1 bg-green-500 text-white rounded-full hover:bg-green-600 transition-colors duration-200 text-sm">
                            <span>ğŸ“</span>
                            <span>Anrufen</span>
                        </button>
                        <button onclick="openWhatsApp('${task.phone}')"
                                class="flex items-center space-x-1 px-3 py-1 bg-green-500 text-white rounded-full hover:bg-green-600 transition-colors duration-200 text-sm">
                            <span>ğŸ’¬</span>
                            <span>WhatsApp</span>
                        </button>
                        <button onclick="copyToClipboard('${task.phone}')"
                                class="flex items-center space-x-1 px-3 py-1 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors duration-200 text-sm">
                            <span>ğŸ“‹</span>
                            <span>${task.phone}</span>
                        </button>
                    </div>
                    ` : ''}
                </div>

                <!-- Finanzielle Informationen -->
                ${task.customerPrice > 0 || task.spareParts > 0 || task.earnings !== 0 ? `
                <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-3 mb-4">
                    <div class="grid grid-cols-3 gap-3 text-center">
                        ${task.customerPrice > 0 ? `
                        <div class="bg-white rounded-lg p-2">
                            <div class="text-xs text-gray-500 mb-1">Kundenpreis</div>
                            <div class="font-bold text-green-600">ğŸ’° ${task.customerPrice.toFixed(2)} â‚¬</div>
                        </div>
                        ` : '<div></div>'}
                        ${task.spareParts > 0 ? `
                        <div class="bg-white rounded-lg p-2">
                            <div class="text-xs text-gray-500 mb-1">Ersatzteile</div>
                            <div class="font-bold text-orange-600">ğŸ”§ ${task.spareParts.toFixed(2)} â‚¬</div>
                        </div>
                        ` : '<div></div>'}
                        ${task.earnings !== 0 ? `
                        <div class="bg-white rounded-lg p-2">
                            <div class="text-xs text-gray-500 mb-1">Einnahmen</div>
                            <div class="font-bold text-${task.earnings >= 0 ? 'green'
      : 'red'}-600">ğŸ“ˆ ${task.earnings.toFixed(2)} â‚¬</div>
                        </div>
                        ` : '<div></div>'}
                    </div>
                </div>
                ` : ''}

                <!-- Zeitstempel -->
                <div class="bg-white border rounded-lg p-3 mb-4">
                    <div class="grid grid-cols-1 gap-2 text-xs text-gray-500">
                        <div class="flex items-center justify-between">
                            <span>ğŸ“… Erstellt:</span>
                            <span class="font-medium">${task.createdAt}</span>
                        </div>
                        ${task.plannedDate ? `
                        <div class="flex items-center justify-between">
                            <span>ğŸ“‹ Geplant fÃ¼r:</span>
                            <span class="font-medium text-blue-600">${new Date(
      task.plannedDate).toLocaleDateString('de-DE')}</span>
                        </div>
                        ` : ''}
                        ${task.completedAt ? `
                        <div class="flex items-center justify-between">
                            <span>âœ… Erledigt am:</span>
                            <span class="font-medium text-green-600">${task.completedAt}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Aktionen -->
                <div class="flex items-center justify-between space-x-3">
                    <button onclick="openNavigation([${task.coordinates[0]}, ${task.coordinates[1]}], '${task.location}')"
                            class="flex items-center space-x-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200 font-medium flex-1">
                        <span>ğŸ§­</span>
                        <span>Navigation</span>
                    </button>

                    <button onclick="editTaskFromModal(${task.id})"
                            class="flex items-center space-x-2 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors duration-200 font-medium flex-1">
                        <span>âœï¸</span>
                        <span>Bearbeiten</span>
                    </button>

                    <button onclick="deleteTaskFromModal(${task.id})"
                            class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-colors duration-200" title="LÃ¶schen">
                        ğŸ—‘ï¸
                    </button>
                </div>
            </div>
        `;

    document.getElementById('taskModalContent').innerHTML = modalContent;
    document.getElementById('taskModal').classList.remove('hidden');
  }

  function closeTaskModal() {
    document.getElementById('taskModal').classList.add('hidden');
  }

  function toggleTaskFromModal(taskId) {
    toggleTask(taskId);
    // Refresh modal content
    openTaskModal(taskId);
    // Update the current view
    updateTaskDisplay();
  }

  function editTaskFromModal(taskId) {
    closeTaskModal();
    editTask(taskId);
  }

  function deleteTaskFromModal(taskId) {
    if (confirm('Aufgabe wirklich lÃ¶schen?')) {
      tasks = tasks.filter(t => t.id !== taskId);
      saveTasksToStorage();
      closeTaskModal();
      updateTaskDisplay();
    }
  }

  // Close modal when clicking outside
  document.addEventListener('click', function(event) {
    const modal = document.getElementById('taskModal');
    if (event.target === modal) {
      closeTaskModal();
    }
  });

  // Close modal with Escape key
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      closeTaskModal();
    }
  });
</script>

<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'967563bfa4fcdcf8',t:'MTc1Mzg4NDEwMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
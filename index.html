<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aufgaben-Planer mit Karte</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    .task-marker {
      background: #3b82f6;
      border: 2px solid white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
    }

    .task-marker.completed {
      background: #10b981;
    }

    .task-marker.high {
      background: #ef4444;
    }

    .task-marker.medium {
      background: #f59e0b;
    }
  </style>
</head>
<body class="bg-gray-50 font-sans">
<div class="max-w-md mx-auto bg-white min-h-screen">
  <!-- Header -->
  <div class="bg-blue-600 text-white p-4 sticky top-0 z-50">
    <h1 class="text-xl font-bold text-center">ğŸ“ Aufgaben-Planer</h1>
    <div class="flex justify-center mt-2 space-x-1">
      <button id="listViewBtn" class="px-2 py-1 bg-blue-500 rounded-full text-xs">ğŸ“‹ Liste</button>
      <button id="mapViewBtn" class="px-2 py-1 bg-blue-700 rounded-full text-xs">ğŸ—ºï¸ Karte</button>
      <button id="calendarViewBtn" class="px-2 py-1 bg-blue-700 rounded-full text-xs">ğŸ“… Kalender
      </button>
      <button id="statsViewBtn" class="px-2 py-1 bg-blue-700 rounded-full text-xs">ğŸ’° Kosten</button>
    </div>
  </div>
  <!-- Add Task Toggle Button -->
  <div class="p-4 bg-white border-b">
    <button id="toggleFormBtn"
            class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium flex items-center justify-center space-x-2">
      <span>â• Neue Aufgabe</span>
    </button>
  </div>

  <!-- Add Task Form -->
  <div id="addTaskForm" class="hidden p-4 bg-white border-b">
    <div class="space-y-3">
      <input type="text" id="taskTitle" placeholder="Aufgabe eingeben..."
             class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">

      <input type="text" id="taskLocation" placeholder="Adresse (z.B. Alexanderplatz 1, Berlin)..."
             class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">

      <input type="number" id="taskCustomerPrice" placeholder="Kundenpreis in â‚¬ (optional)"
             step="0.01" min="0"
             class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">

      <input type="number" id="taskSpareParts" placeholder="Ersatzteile in â‚¬ (optional)" step="0.01"
             min="0"
             class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">

      <input type="tel" id="taskPhone" placeholder="Telefonnummer (optional)"
             class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">

      <div class="w-full p-3 border rounded-lg bg-gray-50">
        <span class="text-gray-600">Einnahmen: </span>
        <span id="calculatedEarnings" class="font-bold text-green-600">0,00 â‚¬</span>
      </div>

      <div class="flex space-x-2">
        <select id="taskPriority"
                class="flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
          <option value="low">ğŸ”µ Offen</option>
          <option value="medium">ğŸŸ¢ Geplant</option>
          <option value="high">ğŸ”´ Dringend</option>
        </select>

        <button id="addTaskBtn"
                class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
          â• HinzufÃ¼gen
        </button>
      </div>

      <button id="cancelFormBtn"
              class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-medium">
        âŒ Abbrechen
      </button>
    </div>
  </div>

  <!-- Edit Task Form -->
  <div id="editTaskForm" class="hidden p-4 bg-white border-b">
    <h3 class="text-lg font-bold mb-3 text-blue-600">âœï¸ Aufgabe bearbeiten</h3>
    <div class="space-y-3">
      <input type="text" id="editTaskTitle" placeholder="Aufgabe eingeben..."
             class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">

      <input type="text" id="editTaskLocation"
             placeholder="Adresse (z.B. Alexanderplatz 1, Berlin)..."
             class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">

      <input type="number" id="editTaskCustomerPrice" placeholder="Kundenpreis in â‚¬ (optional)"
             step="0.01" min="0"
             class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">

      <input type="number" id="editTaskSpareParts" placeholder="Ersatzteile in â‚¬ (optional)"
             step="0.01" min="0"
             class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">

      <input type="tel" id="editTaskPhone" placeholder="Telefonnummer (optional)"
             class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">

      <div class="w-full p-3 border rounded-lg bg-gray-50">
        <span class="text-gray-600">Einnahmen: </span>
        <span id="editCalculatedEarnings" class="font-bold text-green-600">0,00 â‚¬</span>
      </div>

      <div class="flex space-x-2">
        <select id="editTaskPriority"
                class="flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
          <option value="low">ğŸ”µ Offen</option>
          <option value="medium">ğŸŸ¢ Geplant</option>
          <option value="high">ğŸ”´ Dringend</option>
        </select>

        <button id="saveTaskBtn"
                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
          ğŸ’¾ Speichern
        </button>
      </div>

      <button id="cancelEditBtn"
              class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-medium">
        âŒ Abbrechen
      </button>
    </div>
  </div>

  <!-- List View -->
  <div id="listView" class="p-4">
    <div id="taskList" class="space-y-3">
      <!-- Tasks will be added here -->
    </div>
    <div id="emptyState" class="text-center py-16 text-gray-500">
      <div class="bg-gray-50 rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-6">
        <div class="text-4xl">ğŸ“</div>
      </div>
      <h3 class="text-lg font-semibold text-gray-700 mb-2">Keine Aufgaben vorhanden</h3>
      <p class="text-sm text-gray-500 mb-6">FÃ¼gen Sie Ihre erste Aufgabe hinzu und beginnen Sie mit
        der Planung!</p>
      <button onclick="document.getElementById('toggleFormBtn').click()"
              class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200 font-medium">
        â• Erste Aufgabe erstellen
      </button>
    </div>
  </div>

  <!-- Map View -->
  <div id="mapView" class="hidden">
    <div id="map" style="height: calc(100vh - 140px); width: 100%;"></div>
    <div class="p-4 bg-white border-t">
      <div class="flex justify-between items-center text-sm">
        <div class="flex items-center space-x-3 text-xs">
          <span class="flex items-center"><span class="w-3 h-3 bg-red-500 rounded-full mr-1"></span> Dringend</span>
          <span class="flex items-center"><span
              class="w-3 h-3 bg-green-500 rounded-full mr-1"></span> Geplant</span>
          <span class="flex items-center"><span
              class="w-3 h-3 bg-blue-500 rounded-full mr-1"></span> Offen</span>
        </div>
        <span id="taskCount" class="text-gray-600">0 Aufgaben</span>
      </div>
    </div>
  </div>

  <!-- Calendar View -->
  <div id="calendarView" class="hidden p-4">
    <div class="mb-4">
      <!-- Calendar View Toggle -->
      <div class="flex justify-center mb-4 space-x-1">
        <button id="monthViewBtn" class="px-3 py-1 bg-blue-500 text-white rounded-full text-xs">ğŸ“…
          Monat
        </button>
        <button id="weekViewBtn" class="px-3 py-1 bg-blue-700 text-white rounded-full text-xs">ğŸ“†
          Woche
        </button>
        <button id="dayViewBtn" class="px-3 py-1 bg-blue-700 text-white rounded-full text-xs">ğŸ“‹
          Tag
        </button>
      </div>

      <div class="flex justify-between items-center mb-4">
        <button id="prevPeriod" class="p-2 bg-blue-500 text-white rounded hover:bg-blue-600">â€¹
        </button>
        <h3 id="currentPeriod" class="text-lg font-bold"></h3>
        <button id="nextPeriod" class="p-2 bg-blue-500 text-white rounded hover:bg-blue-600">â€º
        </button>
      </div>

      <!-- Month View -->
      <div id="monthView">
        <div class="grid grid-cols-7 gap-1 mb-2">
          <div class="text-center text-xs font-bold p-2 text-gray-600">Mo</div>
          <div class="text-center text-xs font-bold p-2 text-gray-600">Di</div>
          <div class="text-center text-xs font-bold p-2 text-gray-600">Mi</div>
          <div class="text-center text-xs font-bold p-2 text-gray-600">Do</div>
          <div class="text-center text-xs font-bold p-2 text-gray-600">Fr</div>
          <div class="text-center text-xs font-bold p-2 text-gray-600">Sa</div>
          <div class="text-center text-xs font-bold p-2 text-gray-600">So</div>
        </div>

        <div id="calendarGrid" class="grid grid-cols-7 gap-1">
          <!-- Calendar days will be generated here -->
        </div>
      </div>

      <!-- Week View -->
      <div id="weekView" class="hidden">
        <div class="grid grid-cols-7 gap-1 mb-2">
          <div class="text-center text-xs font-bold p-2 text-gray-600">Mo</div>
          <div class="text-center text-xs font-bold p-2 text-gray-600">Di</div>
          <div class="text-center text-xs font-bold p-2 text-gray-600">Mi</div>
          <div class="text-center text-xs font-bold p-2 text-gray-600">Do</div>
          <div class="text-center text-xs font-bold p-2 text-gray-600">Fr</div>
          <div class="text-center text-xs font-bold p-2 text-gray-600">Sa</div>
          <div class="text-center text-xs font-bold p-2 text-gray-600">So</div>
        </div>

        <div id="weekGrid" class="grid grid-cols-7 gap-1">
          <!-- Week days will be generated here -->
        </div>
      </div>

      <!-- Day View -->
      <div id="dayView" class="hidden">
        <div id="dayContainer" class="bg-white border rounded-lg p-4 min-h-[400px]">
          <!-- Day tasks will be generated here -->
        </div>
      </div>
    </div>

    <div class="bg-white border rounded-xl p-5 shadow-sm">
      <div class="flex items-center justify-between mb-4">
        <h4 class="text-lg font-bold text-gray-800 flex items-center">
          <span class="bg-blue-100 p-2 rounded-lg mr-3">ğŸ“‹</span>
          Ungeplante Aufgaben
        </h4>
        <span id="unplannedCount"
              class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm font-medium">0</span>
      </div>
      <div id="unplannedTasks"
           class="space-y-3 min-h-[120px] border-2 border-dashed border-gray-300 rounded-lg p-4 bg-gray-50">
        <!-- Unplanned tasks will be shown here -->
      </div>
    </div>
  </div>

  <!-- Statistics View -->
  <div id="statsView" class="hidden p-4">
    <div class="space-y-4">
      <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg">
        <h3 class="text-lg font-bold mb-2">ğŸ’° EinnahmenÃ¼bersicht</h3>
        <div class="text-2xl font-bold" id="totalCosts">0,00 â‚¬</div>
        <div class="text-sm opacity-90">Gesamteinnahmen erledigter Aufgaben</div>
      </div>

      <div class="bg-white border rounded-lg p-4">
        <h4 class="font-bold mb-3">ğŸ“Š Monatliche Ãœbersicht</h4>
        <div id="monthlyStats" class="space-y-2">
          <!-- Monthly stats will be added here -->
        </div>
      </div>

      <div class="bg-white border rounded-lg p-4">
        <h4 class="font-bold mb-3">ğŸ“ˆ Aktuelle Statistiken</h4>
        <div class="grid grid-cols-2 gap-4 text-center">
          <div class="bg-blue-50 p-3 rounded">
            <div class="text-2xl font-bold text-blue-600" id="openTasks">0</div>
            <div class="text-sm text-gray-600">Offene Aufgaben</div>
          </div>
          <div class="bg-green-50 p-3 rounded">
            <div class="text-2xl font-bold text-green-600" id="completedTasks">0</div>
            <div class="text-sm text-gray-600">Erledigt</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let tasks = [];
  let map = null;
  let currentView = 'list';
  let currentDate = new Date();
  let draggedTask = null;
  let editingTaskId = null;
  let calendarViewMode = 'month'; // 'month', 'week', 'day'

  // LocalStorage functions
  function saveTasksToStorage() {
    try {
      localStorage.setItem('taskPlannerTasks', JSON.stringify(tasks));
    } catch (error) {
      console.error('Fehler beim Speichern der Aufgaben:', error);
    }
  }

  function loadTasksFromStorage() {
    try {
      const storedTasks = localStorage.getItem('taskPlannerTasks');
      if (storedTasks) {
        tasks = JSON.parse(storedTasks);
      }
    } catch (error) {
      console.error('Fehler beim Laden der Aufgaben:', error);
      tasks = [];
    }
  }

  // Geocoding function to get coordinates from address
  async function geocodeAddress(address) {
    try {
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
          address)}&limit=1`);
      const data = await response.json();

      if (data && data.length > 0) {
        return {
          lat: parseFloat(data[0].lat),
          lng: parseFloat(data[0].lon),
          displayName: data[0].display_name
        };
      }
      return null;
    } catch (error) {
      console.error('Geocoding error:', error);
      return null;
    }
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', function () {
    loadTasksFromStorage();
    initializeMap();
    updateTaskDisplay();

    // Event listeners
    document.getElementById('addTaskBtn').addEventListener('click', addTask);
    document.getElementById('toggleFormBtn').addEventListener('click', toggleTaskForm);
    document.getElementById('cancelFormBtn').addEventListener('click', hideTaskForm);
    document.getElementById('saveTaskBtn').addEventListener('click', saveEditedTask);
    document.getElementById('cancelEditBtn').addEventListener('click', hideEditForm);
    document.getElementById('listViewBtn').addEventListener('click', () => switchView('list'));
    document.getElementById('mapViewBtn').addEventListener('click', () => switchView('map'));
    document.getElementById('calendarViewBtn').addEventListener('click',
      () => switchView('calendar'));
    document.getElementById('statsViewBtn').addEventListener('click', () => switchView('stats'));

    // Calendar navigation
    document.getElementById('prevPeriod').addEventListener('click', () => changePeriod(-1));
    document.getElementById('nextPeriod').addEventListener('click', () => changePeriod(1));

    // Calendar view mode buttons
    document.getElementById('monthViewBtn').addEventListener('click',
      () => switchCalendarView('month'));
    document.getElementById('weekViewBtn').addEventListener('click',
      () => switchCalendarView('week'));
    document.getElementById('dayViewBtn').addEventListener('click',
      () => switchCalendarView('day'));

    // Enter key support
    document.getElementById('taskTitle').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        addTask();
      }
    });
    document.getElementById('taskLocation').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        addTask();
      }
    });

    // Calculate earnings when prices change
    document.getElementById('taskCustomerPrice').addEventListener('input', calculateEarnings);
    document.getElementById('taskSpareParts').addEventListener('input', calculateEarnings);
    document.getElementById('editTaskCustomerPrice').addEventListener('input',
      calculateEditEarnings);
    document.getElementById('editTaskSpareParts').addEventListener('input', calculateEditEarnings);
  });

  function initializeMap() {
    map = L.map('map').setView([48.4569, 13.4378], 12); // SchÃ¤rding, OberÃ¶sterreich center

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
  }

  function toggleTaskForm() {
    const form = document.getElementById('addTaskForm');
    const toggleBtn = document.getElementById('toggleFormBtn');

    if (form.classList.contains('hidden')) {
      form.classList.remove('hidden');
      toggleBtn.innerHTML = '<span>â– SchlieÃŸen</span>';
      // Focus on first input
      document.getElementById('taskTitle').focus();
    } else {
      form.classList.add('hidden');
      toggleBtn.innerHTML = '<span>â• Neue Aufgabe</span>';
    }
  }

  function hideTaskForm() {
    const form = document.getElementById('addTaskForm');
    const toggleBtn = document.getElementById('toggleFormBtn');

    form.classList.add('hidden');
    toggleBtn.innerHTML = '<span>â• Neue Aufgabe</span>';

    // Clear form
    document.getElementById('taskTitle').value = '';
    document.getElementById('taskLocation').value = '';
    document.getElementById('taskCustomerPrice').value = '';
    document.getElementById('taskSpareParts').value = '';
    document.getElementById('taskPhone').value = '';
    document.getElementById('taskPriority').value = 'low';
    calculateEarnings();
  }

  function calculateEarnings() {
    const customerPrice = parseFloat(document.getElementById('taskCustomerPrice').value) || 0;
    const spareParts = parseFloat(document.getElementById('taskSpareParts').value) || 0;
    const earnings = customerPrice - spareParts;

    document.getElementById('calculatedEarnings').textContent = earnings.toFixed(2) + ' â‚¬';
    document.getElementById('calculatedEarnings').className = earnings >= 0
      ? 'font-bold text-green-600' : 'font-bold text-red-600';
  }

  function calculateEditEarnings() {
    const customerPrice = parseFloat(document.getElementById('editTaskCustomerPrice').value) || 0;
    const spareParts = parseFloat(document.getElementById('editTaskSpareParts').value) || 0;
    const earnings = customerPrice - spareParts;

    document.getElementById('editCalculatedEarnings').textContent = earnings.toFixed(2) + ' â‚¬';
    document.getElementById('editCalculatedEarnings').className = earnings >= 0
      ? 'font-bold text-green-600' : 'font-bold text-red-600';
  }

  async function addTask() {
    const title = document.getElementById('taskTitle').value.trim();
    const location = document.getElementById('taskLocation').value.trim();
    const customerPrice = parseFloat(document.getElementById('taskCustomerPrice').value) || 0;
    const spareParts = parseFloat(document.getElementById('taskSpareParts').value) || 0;
    const phone = document.getElementById('taskPhone').value.trim();
    const earnings = customerPrice - spareParts;
    const priority = document.getElementById('taskPriority').value;

    if (!title || !location) {
      alert('Bitte fÃ¼llen Sie Titel und Adresse aus!');
      return;
    }

    // Show loading state
    const addBtn = document.getElementById('addTaskBtn');
    const originalText = addBtn.innerHTML;
    addBtn.innerHTML = 'ğŸ”„ Suche Adresse...';
    addBtn.disabled = true;

    try {
      // Get coordinates for the actual address
      const geocodeResult = await geocodeAddress(location);

      if (!geocodeResult) {
        alert('Adresse konnte nicht gefunden werden. Bitte Ã¼berprÃ¼fen Sie die Eingabe.');
        return;
      }

      const task = {
        id: Date.now(),
        title: title,
        location: location,
        fullAddress: geocodeResult.displayName,
        customerPrice: customerPrice,
        spareParts: spareParts,
        phone: phone,
        earnings: earnings,
        priority: priority,
        completed: false,
        coordinates: [geocodeResult.lat, geocodeResult.lng],
        createdAt: new Date().toLocaleDateString('de-DE'),
        completedAt: null,
        plannedDate: null
      };

      tasks.push(task);
      saveTasksToStorage();

      // Clear form and hide it
      hideTaskForm();

      updateTaskDisplay();
    } catch (error) {
      alert('Fehler beim HinzufÃ¼gen der Aufgabe. Bitte versuchen Sie es erneut.');
    } finally {
      // Reset button
      addBtn.innerHTML = originalText;
      addBtn.disabled = false;
    }
  }

  function openNavigation(coordinates, address) {
    const lat = coordinates[0];
    const lng = coordinates[1];

    // Try to open in native maps app first, fallback to Google Maps web
    const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;

    // For mobile devices, try to open native app
    if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
      const nativeUrl = `geo:${lat},${lng}?q=${lat},${lng}(${encodeURIComponent(address)})`;

      // Try native first, fallback to web
      const link = document.createElement('a');
      link.href = nativeUrl;
      link.click();

      // Fallback after short delay
      setTimeout(() => {
        window.open(mapsUrl, '_blank');
      }, 500);
    } else {
      window.open(mapsUrl, '_blank');
    }
  }

  function makePhoneCall(phoneNumber) {
    if (!phoneNumber) {
      return;
    }

    // Clean phone number (remove spaces, dashes, etc.)
    const cleanNumber = phoneNumber.replace(/[^\\d+]/g, '');

    // Create tel: link
    const telLink = `tel:${cleanNumber}`;

    // Try to open phone app
    const link = document.createElement('a');
    link.href = telLink;
    link.click();
  }

  function openWhatsApp(phoneNumber) {
    if (!phoneNumber) {
      return;
    }

    // Clean phone number and ensure it starts with country code
    let cleanNumber = phoneNumber.replace(/[^\\d+]/g, '');

    // If number doesn't start with +, assume German number and add +49
    if (!cleanNumber.startsWith('+')) {
      if (cleanNumber.startsWith('0')) {
        cleanNumber = '+49' + cleanNumber.substring(1);
      } else {
        cleanNumber = '+49' + cleanNumber;
      }
    }

    // Create WhatsApp link
    const whatsappUrl = `https://wa.me/${cleanNumber.replace('+', '')}`;

    // Open WhatsApp
    window.open(whatsappUrl, '_blank');
  }

  function showContactOptions(phoneNumber) {
    if (!phoneNumber) {
      return;
    }

    const options = confirm(
      `Telefonnummer: ${phoneNumber}\\n\\nOK = Anrufen\\nAbbrechen = WhatsApp`);

    if (options) {
      makePhoneCall(phoneNumber);
    } else {
      openWhatsApp(phoneNumber);
    }
  }

  function toggleTask(taskId) {
    const task = tasks.find(t => t.id === taskId);
    if (task) {
      task.completed = !task.completed;
      task.completedAt = task.completed ? new Date().toLocaleDateString('de-DE') : null;
      saveTasksToStorage();
      updateTaskDisplay();
    }
  }

  function editTask(taskId) {
    const task = tasks.find(t => t.id === taskId);
    if (!task) {
      return;
    }

    editingTaskId = taskId;

    // Hide add form if open
    hideTaskForm();

    // Fill edit form with current task data
    document.getElementById('editTaskTitle').value = task.title;
    document.getElementById('editTaskLocation').value = task.location;
    document.getElementById('editTaskCustomerPrice').value = task.customerPrice || '';
    document.getElementById('editTaskSpareParts').value = task.spareParts || '';
    document.getElementById('editTaskPhone').value = task.phone || '';
    document.getElementById('editTaskPriority').value = task.priority;

    // Calculate and display earnings
    calculateEditEarnings();

    // Show edit form
    document.getElementById('editTaskForm').classList.remove('hidden');
    document.getElementById('editTaskTitle').focus();
  }

  function hideEditForm() {
    document.getElementById('editTaskForm').classList.add('hidden');
    editingTaskId = null;

    // Clear form
    document.getElementById('editTaskTitle').value = '';
    document.getElementById('editTaskLocation').value = '';
    document.getElementById('editTaskCustomerPrice').value = '';
    document.getElementById('editTaskSpareParts').value = '';
    document.getElementById('editTaskPhone').value = '';
    document.getElementById('editTaskPriority').value = 'low';
    calculateEditEarnings();
  }

  async function saveEditedTask() {
    if (!editingTaskId) {
      return;
    }

    const title = document.getElementById('editTaskTitle').value.trim();
    const location = document.getElementById('editTaskLocation').value.trim();
    const customerPrice = parseFloat(document.getElementById('editTaskCustomerPrice').value) || 0;
    const spareParts = parseFloat(document.getElementById('editTaskSpareParts').value) || 0;
    const phone = document.getElementById('editTaskPhone').value.trim();
    const earnings = customerPrice - spareParts;
    const priority = document.getElementById('editTaskPriority').value;

    if (!title || !location) {
      alert('Bitte fÃ¼llen Sie Titel und Adresse aus!');
      return;
    }

    const task = tasks.find(t => t.id === editingTaskId);
    if (!task) {
      return;
    }

    // Check if location changed - if so, get new coordinates
    if (task.location !== location) {
      // Show loading state
      const saveBtn = document.getElementById('saveTaskBtn');
      const originalText = saveBtn.innerHTML;
      saveBtn.innerHTML = 'ğŸ”„ Suche Adresse...';
      saveBtn.disabled = true;

      try {
        const geocodeResult = await geocodeAddress(location);

        if (!geocodeResult) {
          alert('Adresse konnte nicht gefunden werden. Bitte Ã¼berprÃ¼fen Sie die Eingabe.');
          return;
        }

        // Update task with new coordinates
        task.coordinates = [geocodeResult.lat, geocodeResult.lng];
        task.fullAddress = geocodeResult.displayName;
      } catch (error) {
        alert('Fehler beim Suchen der Adresse. Bitte versuchen Sie es erneut.');
        return;
      } finally {
        // Reset button
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
      }
    }

    // Update task data
    task.title = title;
    task.location = location;
    task.customerPrice = customerPrice;
    task.spareParts = spareParts;
    task.phone = phone;
    task.earnings = earnings;
    task.priority = priority;

    // Save to storage and update display
    saveTasksToStorage();
    hideEditForm();
    updateTaskDisplay();
  }

  function deleteTask(taskId) {
    if (confirm('Aufgabe wirklich lÃ¶schen?')) {
      tasks = tasks.filter(t => t.id !== taskId);
      saveTasksToStorage();
      updateTaskDisplay();
    }
  }

  function updateTaskDisplay() {
    if (currentView === 'list') {
      updateListView();
    } else if (currentView === 'map') {
      updateMapView();
    } else if (currentView === 'calendar') {
      updateCalendarView();
    } else if (currentView === 'stats') {
      updateStatsView();
    }
    updateTaskCount();
  }

  function changePeriod(direction) {
    if (calendarViewMode === 'month') {
      currentDate.setMonth(currentDate.getMonth() + direction);
    } else if (calendarViewMode === 'week') {
      currentDate.setDate(currentDate.getDate() + (direction * 7));
    } else if (calendarViewMode === 'day') {
      currentDate.setDate(currentDate.getDate() + direction);
    }
    updateCalendarView();
  }

  function switchCalendarView(mode) {
    calendarViewMode = mode;

    // Update button styles
    const monthBtn = document.getElementById('monthViewBtn');
    const weekBtn = document.getElementById('weekViewBtn');
    const dayBtn = document.getElementById('dayViewBtn');

    [monthBtn, weekBtn, dayBtn].forEach(btn => {
      btn.classList.remove('bg-blue-500');
      btn.classList.add('bg-blue-700');
    });

    if (mode === 'month') {
      monthBtn.classList.remove('bg-blue-700');
      monthBtn.classList.add('bg-blue-500');
    } else if (mode === 'week') {
      weekBtn.classList.remove('bg-blue-700');
      weekBtn.classList.add('bg-blue-500');
    } else if (mode === 'day') {
      dayBtn.classList.remove('bg-blue-700');
      dayBtn.classList.add('bg-blue-500');
    }

    updateCalendarView();
  }

  function updateCalendarView() {
    const monthNames = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni',
      'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
    const dayNames = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag',
      'Samstag'];

    // Hide all views first
    document.getElementById('monthView').classList.add('hidden');
    document.getElementById('weekView').classList.add('hidden');
    document.getElementById('dayView').classList.add('hidden');

    if (calendarViewMode === 'month') {
      document.getElementById('monthView').classList.remove('hidden');
      updateMonthView(monthNames);
    } else if (calendarViewMode === 'week') {
      document.getElementById('weekView').classList.remove('hidden');
      updateWeekView(monthNames);
    } else if (calendarViewMode === 'day') {
      document.getElementById('dayView').classList.remove('hidden');
      updateDayView(monthNames, dayNames);
    }

    // Update unplanned tasks
    updateUnplannedTasks();
  }

  function updateMonthView(monthNames) {
    document.getElementById('currentPeriod').textContent =
      `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - (firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1));

    const calendarGrid = document.getElementById('calendarGrid');
    calendarGrid.innerHTML = '';

    for (let i = 0; i < 42; i++) {
      const cellDate = new Date(startDate);
      cellDate.setDate(startDate.getDate() + i);

      const isCurrentMonth = cellDate.getMonth() === currentDate.getMonth();
      const isToday = cellDate.toDateString() === new Date().toDateString();
      const dateStr = cellDate.toISOString().split('T')[0];

      const dayTasks = tasks.filter(task => task.plannedDate === dateStr);

      const cell = document.createElement('div');
      cell.className = `min-h-[80px] border rounded p-1 ${isCurrentMonth ? 'bg-white'
        : 'bg-gray-100'} ${isToday ? 'ring-2 ring-blue-500' : ''}`;
      cell.setAttribute('data-date', dateStr);

      cell.innerHTML = `
                <div class="text-xs font-bold mb-1 ${isCurrentMonth ? 'text-gray-900'
        : 'text-gray-400'}">${cellDate.getDate()}</div>
                <div class="space-y-1" id="tasks-${dateStr}">
                    ${dayTasks.map(task => createTaskElement(task, true)).join('')}
                </div>
            `;

      // Add drop functionality
      cell.addEventListener('dragover', handleDragOver);
      cell.addEventListener('drop', handleDrop);
      cell.addEventListener('dragleave', (e) => e.currentTarget.classList.remove('bg-blue-50'));

      calendarGrid.appendChild(cell);
    }
  }

  function updateWeekView(monthNames) {
    // Get start of week (Monday)
    const startOfWeek = new Date(currentDate);
    const day = startOfWeek.getDay();
    const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1);
    startOfWeek.setDate(diff);

    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);

    // Update header
    if (startOfWeek.getMonth() === endOfWeek.getMonth()) {
      document.getElementById('currentPeriod').textContent =
        `${startOfWeek.getDate()}-${endOfWeek.getDate()} ${monthNames[startOfWeek.getMonth()]} ${startOfWeek.getFullYear()}`;
    } else {
      document.getElementById('currentPeriod').textContent =
        `${startOfWeek.getDate()} ${monthNames[startOfWeek.getMonth()]} - ${endOfWeek.getDate()} ${monthNames[endOfWeek.getMonth()]} ${startOfWeek.getFullYear()}`;
    }

    const weekGrid = document.getElementById('weekGrid');
    weekGrid.innerHTML = '';

    for (let i = 0; i < 7; i++) {
      const cellDate = new Date(startOfWeek);
      cellDate.setDate(startOfWeek.getDate() + i);

      const isToday = cellDate.toDateString() === new Date().toDateString();
      const dateStr = cellDate.toISOString().split('T')[0];

      const dayTasks = tasks.filter(task => task.plannedDate === dateStr);

      const cell = document.createElement('div');
      cell.className = `min-h-[120px] border rounded p-2 bg-white ${isToday ? 'ring-2 ring-blue-500'
        : ''}`;
      cell.setAttribute('data-date', dateStr);

      cell.innerHTML = `
                <div class="text-sm font-bold mb-2 text-gray-900">${cellDate.getDate()}</div>
                <div class="space-y-1" id="tasks-${dateStr}">
                    ${dayTasks.map(task => createTaskElement(task, true)).join('')}
                </div>
            `;

      // Add drop functionality
      cell.addEventListener('dragover', handleDragOver);
      cell.addEventListener('drop', handleDrop);
      cell.addEventListener('dragleave', (e) => e.currentTarget.classList.remove('bg-blue-50'));

      weekGrid.appendChild(cell);
    }
  }

  function updateDayView(monthNames, dayNames) {
    const dayName = dayNames[currentDate.getDay()];
    document.getElementById('currentPeriod').textContent =
      `${dayName}, ${currentDate.getDate()} ${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

    const dateStr = currentDate.toISOString().split('T')[0];
    const dayTasks = tasks.filter(task => task.plannedDate === dateStr);

    const dayContainer = document.getElementById('dayContainer');
    dayContainer.setAttribute('data-date', dateStr);

    if (dayTasks.length === 0) {
      dayContainer.innerHTML = `
                <div class="text-center py-16 text-gray-500">
                    <div class="bg-gray-50 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-6">
                        <div class="text-3xl">ğŸ“…</div>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Keine Aufgaben fÃ¼r diesen Tag</h3>
                    <p class="text-sm text-gray-500 mb-4">Ziehen Sie Aufgaben aus der ungeplanten Liste hierher</p>
                    <div class="bg-blue-50 border-2 border-dashed border-blue-200 rounded-lg p-4 text-blue-600">
                        <span class="text-2xl">ğŸ”„</span>
                        <p class="text-sm mt-2">Drag & Drop Zone</p>
                    </div>
                </div>
            `;
    } else {
      dayContainer.innerHTML = `
                <h4 class="font-bold mb-4 text-lg">ğŸ“‹ Aufgaben fÃ¼r heute (${dayTasks.length})</h4>
                <div class="space-y-3">
                    ${dayTasks.map(task => createDetailedTaskElement(task)).join('')}
                </div>
            `;
    }

    // Add drop functionality
    dayContainer.addEventListener('dragover', handleDragOver);
    dayContainer.addEventListener('drop', handleDrop);
    dayContainer.addEventListener('dragleave',
      (e) => e.currentTarget.classList.remove('bg-blue-50'));
  }

  function createDetailedTaskElement(task) {
    const priorityColors = {
      low: 'border-l-blue-500',
      medium: 'border-l-green-500',
      high: 'border-l-red-500'
    };

    const priorityIcons = {
      low: 'ğŸ”µ',
      medium: 'ğŸŸ¢',
      high: 'ğŸ”´'
    };

    return `
            <div class="bg-white border-l-4 ${priorityColors[task.priority]} rounded-xl p-5 shadow-md hover:shadow-lg transition-shadow duration-200 ${task.completed
      ? 'opacity-75' : ''}">
                <!-- Header -->
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center space-x-3 flex-1">
                        <button onclick="toggleTask(${task.id}); updateCalendarView();"
                                class="w-6 h-6 rounded-full border-2 ${task.completed
      ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 hover:border-blue-400'} flex items-center justify-center transition-colors duration-200 flex-shrink-0">
                            ${task.completed ? 'âœ“' : ''}
                        </button>
                        <h3 class="text-lg font-semibold ${task.completed
      ? 'line-through text-gray-500' : 'text-gray-900'} leading-tight">${task.title}</h3>
                    </div>
                    <div class="flex items-center space-x-2 ml-4">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${task.priority
    === 'high' ? 'bg-red-100 text-red-700' : task.priority === 'medium'
      ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">
                            ${priorityIcons[task.priority]} ${task.priority === 'low' ? 'Offen'
      : task.priority === 'medium' ? 'Geplant' : 'Dringend'}
                        </span>
                        <button onclick="editTask(${task.id})"
                                class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg transition-colors duration-200" title="Bearbeiten">
                            âœï¸
                        </button>
                    </div>
                </div>

                <!-- Adresse und Kontakt -->
                <div class="bg-gray-50 rounded-lg p-3 mb-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2 text-gray-700">
                            <span class="text-blue-500">ğŸ“</span>
                            <span class="font-medium">${task.location}</span>
                        </div>
                        ${task.phone ? `
                        <button onclick="showContactOptions('${task.phone}')"
                                class="flex items-center space-x-1 px-3 py-1 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors duration-200 text-sm">
                            <span>ğŸ“</span>
                            <span>${task.phone}</span>
                        </button>
                        ` : ''}
                    </div>
                </div>

                <!-- Finanzielle Informationen -->
                ${task.customerPrice > 0 || task.spareParts > 0 || task.earnings !== 0 ? `
                <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-3 mb-4">
                    <div class="grid grid-cols-3 gap-3 text-center">
                        ${task.customerPrice > 0 ? `
                        <div class="bg-white rounded-lg p-2">
                            <div class="text-xs text-gray-500 mb-1">Kundenpreis</div>
                            <div class="font-bold text-green-600">ğŸ’° ${task.customerPrice.toFixed(2)} â‚¬</div>
                        </div>
                        ` : '<div></div>'}
                        ${task.spareParts > 0 ? `
                        <div class="bg-white rounded-lg p-2">
                            <div class="text-xs text-gray-500 mb-1">Ersatzteile</div>
                            <div class="font-bold text-orange-600">ğŸ”§ ${task.spareParts.toFixed(2)} â‚¬</div>
                        </div>
                        ` : '<div></div>'}
                        ${task.earnings !== 0 ? `
                        <div class="bg-white rounded-lg p-2">
                            <div class="text-xs text-gray-500 mb-1">Einnahmen</div>
                            <div class="font-bold text-${task.earnings >= 0 ? 'green'
      : 'red'}-600">ğŸ“ˆ ${task.earnings.toFixed(2)} â‚¬</div>
                        </div>
                        ` : '<div></div>'}
                    </div>
                </div>
                ` : ''}

                <!-- Aktionen -->
                <div class="flex items-center justify-between">
                    <button onclick="openNavigation([${task.coordinates[0]}, ${task.coordinates[1]}], '${task.location}')"
                            class="flex items-center space-x-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200 font-medium">
                        <span>ğŸ§­</span>
                        <span>Navigation</span>
                    </button>

                    <button onclick="unplanTask(${task.id})"
                            class="flex items-center space-x-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors duration-200 font-medium">
                        <span>âŒ</span>
                        <span>Entfernen</span>
                    </button>
                </div>
            </div>
        `;
  }

  function updateUnplannedTasks() {
    const unplannedTasks = tasks.filter(task => !task.plannedDate);
    const container = document.getElementById('unplannedTasks');
    const counter = document.getElementById('unplannedCount');

    if (counter) {
      counter.textContent = unplannedTasks.length;
    }

    if (unplannedTasks.length === 0) {
      container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <div class="bg-green-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl">âœ…</span>
                    </div>
                    <p class="font-medium text-gray-700">Alle Aufgaben sind geplant!</p>
                    <p class="text-sm text-gray-500 mt-1">GroÃŸartig! Ihre Planung ist vollstÃ¤ndig.</p>
                </div>
            `;
    } else {
      container.innerHTML = unplannedTasks.map(task => createUnplannedTaskElement(task)).join('');
    }
  }

  function createUnplannedTaskElement(task) {
    const priorityColors = {
      low: 'bg-blue-50 border-blue-200 hover:bg-blue-100',
      medium: 'bg-green-50 border-green-200 hover:bg-green-100',
      high: 'bg-red-50 border-red-200 hover:bg-red-100'
    };

    return `
            <div class="task-item ${priorityColors[task.priority]} border-2 rounded-lg p-3 cursor-move text-sm transition-colors duration-200 ${task.completed
      ? 'opacity-60' : ''}"
                 draggable="true"
                 data-task-id="${task.id}"
                 ondragstart="handleDragStart(event)">
                <div class="flex items-start space-x-3">
                    <button onclick="toggleTask(${task.id}); updateCalendarView();"
                            class="w-5 h-5 rounded-full border-2 ${task.completed
      ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 hover:border-blue-400'} flex items-center justify-center text-xs mt-0.5 transition-colors duration-200 flex-shrink-0">
                        ${task.completed ? 'âœ“' : ''}
                    </button>
                    <div class="flex-1 min-w-0">
                        <div class="font-semibold truncate ${task.completed
      ? 'line-through text-gray-500' : 'text-gray-900'} mb-1">${task.title}</div>
                        <div class="flex items-center text-gray-600 mb-2">
                            <span class="text-blue-500 mr-1">ğŸ“</span>
                            <span class="truncate text-xs">${task.location}</span>
                        </div>

                        ${task.phone ? `
                        <button onclick="showContactOptions('${task.phone}')"
                                class="flex items-center space-x-1 px-2 py-1 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors duration-200 text-xs mb-2">
                            <span>ğŸ“</span>
                            <span class="truncate">${task.phone}</span>
                        </button>
                        ` : ''}

                        <div class="flex items-center justify-between text-xs">
                            ${task.customerPrice > 0 || task.earnings !== 0 ? `
                            <div class="flex items-center space-x-2">
                                ${task.customerPrice > 0
      ? `<span class="text-green-600 font-medium">ğŸ’° ${task.customerPrice.toFixed(2)}â‚¬</span>` : ''}
                                ${task.earnings !== 0 ? `<span class="text-${task.earnings >= 0
      ? 'green' : 'red'}-600 font-medium">ğŸ“ˆ ${task.earnings.toFixed(2)}â‚¬</span>` : ''}
                            </div>
                            ` : '<div></div>'}

                            ${task.completed
      ? '<span class="text-green-600 font-medium">âœ… Erledigt</span>'
      : '<span class="text-gray-400">ğŸ”„ Ziehen zum Planen</span>'}
                        </div>
                    </div>
                </div>
            </div>
        `;
  }

  function createTaskElement(task, isPlanned) {
    const priorityColors = {
      low: 'bg-blue-50 border-blue-200 hover:bg-blue-100',
      medium: 'bg-green-50 border-green-200 hover:bg-green-100',
      high: 'bg-red-50 border-red-200 hover:bg-red-100'
    };

    return `
            <div class="task-item ${priorityColors[task.priority]} border-2 rounded-lg p-2 cursor-move text-xs transition-colors duration-200 ${task.completed
      ? 'opacity-60' : ''}"
                 draggable="true"
                 data-task-id="${task.id}"
                 ondragstart="handleDragStart(event)">
                <div class="font-semibold truncate ${task.completed ? 'line-through text-gray-500'
      : 'text-gray-900'} mb-1">${task.title}</div>
                <div class="flex items-center text-gray-600 mb-1">
                    <span class="text-blue-500 mr-1">ğŸ“</span>
                    <span class="truncate">${task.location}</span>
                </div>

                <div class="flex items-center justify-between">
                    ${task.phone
      ? `<button onclick="showContactOptions('${task.phone}')" class="text-blue-600 hover:text-blue-800 font-medium">ğŸ“</button>`
      : '<div></div>'}
                    ${task.completed ? '<span class="text-green-600 font-medium">âœ…</span>' : ''}
                </div>

                ${task.customerPrice > 0
      ? `<div class="text-green-600 font-medium mt-1">ğŸ’° ${task.customerPrice.toFixed(2)}â‚¬</div>`
      : ''}

                ${isPlanned ? `
                <button onclick="unplanTask(${task.id})"
                        class="w-full text-center text-red-500 hover:text-red-700 font-medium mt-2 py-1 hover:bg-red-50 rounded transition-colors duration-200">
                    âŒ Entfernen
                </button>
                ` : ''}
            </div>
        `;
  }

  function handleDragStart(event) {
    draggedTask = parseInt(event.target.getAttribute('data-task-id'));
    event.dataTransfer.effectAllowed = 'move';
  }

  function handleDragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
    event.currentTarget.classList.add('bg-blue-50');
  }

  function handleDrop(event) {
    event.preventDefault();
    event.currentTarget.classList.remove('bg-blue-50');

    if (draggedTask) {
      const targetDate = event.currentTarget.getAttribute('data-date');
      const task = tasks.find(t => t.id === draggedTask);

      if (task) {
        task.plannedDate = targetDate;
        saveTasksToStorage();
        updateCalendarView();
      }

      draggedTask = null;
    }
  }

  function unplanTask(taskId) {
    const task = tasks.find(t => t.id === taskId);
    if (task) {
      task.plannedDate = null;
      saveTasksToStorage();
      updateCalendarView();
    }
  }

  function updateListView() {
    const taskList = document.getElementById('taskList');
    const emptyState = document.getElementById('emptyState');

    if (tasks.length === 0) {
      taskList.innerHTML = '';
      emptyState.style.display = 'block';
      return;
    }

    emptyState.style.display = 'none';

    taskList.innerHTML = tasks.map(task => {
      const priorityColors = {
        low: 'border-l-blue-500',
        medium: 'border-l-green-500',
        high: 'border-l-red-500'
      };

      const priorityIcons = {
        low: 'ğŸ”µ',
        medium: 'ğŸŸ¢',
        high: 'ğŸ”´'
      };

      return `
                <div class="bg-white border-l-4 ${priorityColors[task.priority]} rounded-xl p-5 shadow-lg hover:shadow-xl transition-shadow duration-200 ${task.completed
        ? 'opacity-75' : ''}">
                    <!-- Header mit Titel und Status -->
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center space-x-3 flex-1">
                            <button onclick="toggleTask(${task.id})"
                                    class="w-6 h-6 rounded-full border-2 ${task.completed
        ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 hover:border-blue-400'} flex items-center justify-center transition-colors duration-200 flex-shrink-0">
                                ${task.completed ? 'âœ“' : ''}
                            </button>
                            <h3 class="text-lg font-semibold ${task.completed
        ? 'line-through text-gray-500' : 'text-gray-900'} leading-tight">${task.title}</h3>
                        </div>
                        <div class="flex items-center space-x-2 ml-4">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${task.priority
      === 'high' ? 'bg-red-100 text-red-700' : task.priority === 'medium'
        ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">
                                ${priorityIcons[task.priority]} ${task.priority === 'low' ? 'Offen'
        : task.priority === 'medium' ? 'Geplant' : 'Dringend'}
                            </span>
                        </div>
                    </div>

                    <!-- Adresse und Kontakt -->
                    <div class="bg-gray-50 rounded-lg p-3 mb-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2 text-gray-700">
                                <span class="text-blue-500">ğŸ“</span>
                                <span class="font-medium">${task.location}</span>
                            </div>
                            ${task.phone ? `
                            <button onclick="showContactOptions('${task.phone}')"
                                    class="flex items-center space-x-1 px-3 py-1 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors duration-200 text-sm">
                                <span>ğŸ“</span>
                                <span>${task.phone}</span>
                            </button>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Finanzielle Informationen -->
                    ${task.customerPrice > 0 || task.spareParts > 0 || task.earnings !== 0 ? `
                    <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-3 mb-4">
                        <div class="grid grid-cols-3 gap-3 text-center">
                            ${task.customerPrice > 0 ? `
                            <div class="bg-white rounded-lg p-2">
                                <div class="text-xs text-gray-500 mb-1">Kundenpreis</div>
                                <div class="font-bold text-green-600">ğŸ’° ${task.customerPrice.toFixed(
        2)} â‚¬</div>
                            </div>
                            ` : '<div></div>'}
                            ${task.spareParts > 0 ? `
                            <div class="bg-white rounded-lg p-2">
                                <div class="text-xs text-gray-500 mb-1">Ersatzteile</div>
                                <div class="font-bold text-orange-600">ğŸ”§ ${task.spareParts.toFixed(
        2)} â‚¬</div>
                            </div>
                            ` : '<div></div>'}
                            ${task.earnings !== 0 ? `
                            <div class="bg-white rounded-lg p-2">
                                <div class="text-xs text-gray-500 mb-1">Einnahmen</div>
                                <div class="font-bold text-${task.earnings >= 0 ? 'green'
        : 'red'}-600">ğŸ“ˆ ${task.earnings.toFixed(2)} â‚¬</div>
                            </div>
                            ` : '<div></div>'}
                        </div>
                    </div>
                    ` : ''}

                    <!-- Zeitstempel -->
                    <div class="flex items-center justify-between text-xs text-gray-400 mb-4 bg-gray-50 rounded-lg p-2">
                        <span>ğŸ“… Erstellt: ${task.createdAt}</span>
                        ${task.plannedDate ? `<span class="text-blue-500">ğŸ“‹ Geplant: ${new Date(
        task.plannedDate).toLocaleDateString('de-DE')}</span>` : ''}
                        ${task.completedAt
        ? `<span class="text-green-500">âœ… Erledigt: ${task.completedAt}</span>` : ''}
                    </div>

                    <!-- Aktionen -->
                    <div class="flex items-center justify-between">
                        <button onclick="openNavigation([${task.coordinates[0]}, ${task.coordinates[1]}], '${task.location}')"
                                class="flex items-center space-x-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200 font-medium">
                            <span>ğŸ§­</span>
                            <span>Navigation</span>
                        </button>

                        <div class="flex items-center space-x-2">
                            <button onclick="editTask(${task.id})"
                                    class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg transition-colors duration-200" title="Bearbeiten">
                                âœï¸
                            </button>
                            <button onclick="deleteTask(${task.id})"
                                    class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors duration-200" title="LÃ¶schen">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>

                    ${task.fullAddress ? `
                    <div class="mt-3 pt-3 border-t border-gray-100">
                        <div class="text-xs text-gray-500 flex items-start space-x-2">
                            <span class="text-gray-400">ğŸ </span>
                            <span class="leading-relaxed">${task.fullAddress}</span>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
    }).join('');
  }

  function updateMapView() {
    if (!map) {
      return;
    }

    // Clear existing markers
    map.eachLayer(layer => {
      if (layer instanceof L.Marker) {
        map.removeLayer(layer);
      }
    });

    // Add markers for each task (exclude completed tasks)
    tasks.filter(task => !task.completed).forEach(task => {
      if (task.coordinates) {
        const markerColor = task.priority === 'high' ? '#ef4444' : // rot = dringend
          task.plannedDate ? '#10b981' : // grÃ¼n = geplant
            '#3b82f6'; // blau = offen

        const marker = L.circleMarker(task.coordinates, {
          radius: 8,
          fillColor: markerColor,
          color: 'white',
          weight: 2,
          opacity: 1,
          fillOpacity: 0.8
        }).addTo(map);

        const popupContent = `
                    <div class="p-2">
                        <h4 class="font-bold text-sm mb-1">${task.title}</h4>
                        <p class="text-xs text-gray-600 mb-2">ğŸ“ ${task.location}</p>
                        ${task.phone
          ? `<button onclick="showContactOptions('${task.phone}')" class="text-xs text-blue-600 hover:text-blue-800 mb-2 block">ğŸ“ ${task.phone}</button>`
          : ''}
                        ${task.customerPrice > 0
          ? `<p class="text-xs text-gray-600 mb-1">ğŸ’° Kundenpreis: ${task.customerPrice.toFixed(
            2)} â‚¬</p>` : ''}
                        ${task.spareParts > 0
          ? `<p class="text-xs text-gray-600 mb-1">ğŸ”§ Ersatzteile: ${task.spareParts.toFixed(
            2)} â‚¬</p>` : ''}
                        ${task.earnings !== 0 ? `<p class="text-xs text-${task.earnings >= 0
          ? 'green' : 'red'}-600 mb-2">ğŸ“ˆ Einnahmen: ${task.earnings.toFixed(2)} â‚¬</p>` : ''}
                        ${task.fullAddress
          ? `<p class="text-xs text-gray-500 mb-2">${task.fullAddress}</p>` : ''}
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs ${task.completed ? 'text-green-600'
          : 'text-gray-500'}">
                                ${task.completed ? 'âœ… Erledigt' : 'â³ Offen'}
                                ${task.completedAt ? ` (${task.completedAt})` : ''}
                            </span>
                            <button onclick="toggleTask(${task.id}); updateMapView();"
                                    class="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                                ${task.completed ? 'RÃ¼ckgÃ¤ngig' : 'Erledigen'}
                            </button>
                        </div>
                        <button onclick="openNavigation([${task.coordinates[0]}, ${task.coordinates[1]}], '${task.location}')"
                                class="w-full text-xs px-2 py-1 bg-green-500 text-white rounded hover:bg-green-600">
                            ğŸ§­ Navigation starten
                        </button>
                    </div>
                `;

        marker.bindPopup(popupContent);
      }
    });

    // Fit map to show all markers
    if (tasks.length > 0) {
      const group = new L.featureGroup(map._layers);
      if (Object.keys(group._layers).length > 0) {
        map.fitBounds(group.getBounds().pad(0.1));
      }
    }
  }

  function updateStatsView() {
    const completedTasks = tasks.filter(t => t.completed);
    const totalEarnings = completedTasks.reduce((sum, task) => sum + task.earnings, 0);

    // Update total earnings
    document.getElementById('totalCosts').textContent = totalEarnings.toFixed(2) + ' â‚¬';

    // Calculate monthly statistics
    const monthlyData = {};
    completedTasks.forEach(task => {
      if (task.completedAt) {
        const [day, month, year] = task.completedAt.split('.');
        const monthKey = `${month}.${year}`;
        if (!monthlyData[monthKey]) {
          monthlyData[monthKey] = { count: 0, earnings: 0 };
        }
        monthlyData[monthKey].count++;
        monthlyData[monthKey].earnings += task.earnings;
      }
    });

    // Display monthly stats
    const monthlyStatsDiv = document.getElementById('monthlyStats');
    if (Object.keys(monthlyData).length === 0) {
      monthlyStatsDiv.innerHTML = '<p class="text-gray-500 text-sm">Noch keine erledigten Aufgaben</p>';
    } else {
      monthlyStatsDiv.innerHTML = Object.entries(monthlyData)
      .sort(([a], [b]) => b.localeCompare(a))
      .map(([month, data]) => `
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span class="font-medium">${month}</span>
                        <div class="text-right">
                            <div class="font-bold ${data.earnings >= 0 ? 'text-green-600'
        : 'text-red-600'}">${data.earnings.toFixed(2)} â‚¬</div>
                            <div class="text-xs text-gray-500">${data.count} Aufgaben</div>
                        </div>
                    </div>
                `).join('');
    }

    // Update task counts
    document.getElementById('openTasks').textContent = tasks.filter(t => !t.completed).length;
    document.getElementById('completedTasks').textContent = completedTasks.length;
  }

  function switchView(view) {
    currentView = view;

    const listView = document.getElementById('listView');
    const mapView = document.getElementById('mapView');
    const calendarView = document.getElementById('calendarView');
    const statsView = document.getElementById('statsView');
    const listBtn = document.getElementById('listViewBtn');
    const mapBtn = document.getElementById('mapViewBtn');
    const calendarBtn = document.getElementById('calendarViewBtn');
    const statsBtn = document.getElementById('statsViewBtn');

    // Hide all views
    listView.classList.add('hidden');
    mapView.classList.add('hidden');
    calendarView.classList.add('hidden');
    statsView.classList.add('hidden');

    // Reset button styles
    [listBtn, mapBtn, calendarBtn, statsBtn].forEach(btn => {
      btn.classList.remove('bg-blue-500');
      btn.classList.add('bg-blue-700');
    });

    if (view === 'list') {
      listView.classList.remove('hidden');
      listBtn.classList.remove('bg-blue-700');
      listBtn.classList.add('bg-blue-500');
      updateListView();
    } else if (view === 'map') {
      mapView.classList.remove('hidden');
      mapBtn.classList.remove('bg-blue-700');
      mapBtn.classList.add('bg-blue-500');
      setTimeout(() => {
        map.invalidateSize();
        updateMapView();
      }, 100);
    } else if (view === 'calendar') {
      calendarView.classList.remove('hidden');
      calendarBtn.classList.remove('bg-blue-700');
      calendarBtn.classList.add('bg-blue-500');
      updateCalendarView();
    } else if (view === 'stats') {
      statsView.classList.remove('hidden');
      statsBtn.classList.remove('bg-blue-700');
      statsBtn.classList.add('bg-blue-500');
      updateStatsView();
    }
  }

  function updateTaskCount() {
    const count = tasks.length;
    const completed = tasks.filter(t => t.completed).length;
    document.getElementById('taskCount').textContent = `${count} Aufgaben (${completed} erledigt)`;
  }
</script>
<script>(function () {
  function c() {
    var b = a.contentDocument || a.contentWindow.document;
    if (b) {
      var d = b.createElement('script');
      d.innerHTML = "window.__CF$cv$params={r:'966c5dcf127bb86d',t:'MTc1Mzc4OTQ4OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
      b.getElementsByTagName('head')[0].appendChild(d)
    }
  }

  if (document.body) {
    var a = document.createElement('iframe');
    a.height = 1;
    a.width = 1;
    a.style.position = 'absolute';
    a.style.top = 0;
    a.style.left = 0;
    a.style.border = 'none';
    a.style.visibility = 'hidden';
    document.body.appendChild(a);
    if ('loading'
      !== document.readyState) {
      c();
    } else if (window.addEventListener) {
      document.addEventListener(
        'DOMContentLoaded', c);
    } else {
      var e = document.onreadystatechange || function () {
      };
      document.onreadystatechange = function (b) {
        e(b);
        'loading' !== document.readyState && (document.onreadystatechange = e, c())
      }
    }
  }
})();</script>
</body>
</html>